<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Mixed Models - Mixed models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./environment.html" rel="next">
<link href="./lm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./lmm.html">Mixed models</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Mixed Models</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simple linear regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lmm.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Mixed models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./environment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Environment</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#why-mixed" id="toc-why-mixed" class="nav-link active" data-scroll-target="#why-mixed">Why “Mixed”?</a>
  <ul class="collapse">
  <li><a href="#fixed-effects" id="toc-fixed-effects" class="nav-link" data-scroll-target="#fixed-effects">Fixed Effects</a></li>
  <li><a href="#random-effect" id="toc-random-effect" class="nav-link" data-scroll-target="#random-effect">Random effect</a></li>
  </ul></li>
  <li><a href="#ingredients" id="toc-ingredients" class="nav-link" data-scroll-target="#ingredients">Ingredients</a>
  <ul class="collapse">
  <li><a href="#grouping-structure-of-the-data" id="toc-grouping-structure-of-the-data" class="nav-link" data-scroll-target="#grouping-structure-of-the-data">Grouping Structure of the Data</a></li>
  <li><a href="#design-for-fixed-and-random-effects" id="toc-design-for-fixed-and-random-effects" class="nav-link" data-scroll-target="#design-for-fixed-and-random-effects">Design for fixed and random effects</a></li>
  </ul></li>
  <li><a href="#examples-mixed-models-in-r" id="toc-examples-mixed-models-in-r" class="nav-link" data-scroll-target="#examples-mixed-models-in-r">Examples (Mixed models in R )</a>
  <ul class="collapse">
  <li><a href="#predicting-the-random-intercept" id="toc-predicting-the-random-intercept" class="nav-link" data-scroll-target="#predicting-the-random-intercept">Predicting the random intercept</a></li>
  <li><a href="#random-slope" id="toc-random-slope" class="nav-link" data-scroll-target="#random-slope">Random slope</a></li>
  <li><a href="#nested-and-crossed-designs" id="toc-nested-and-crossed-designs" class="nav-link" data-scroll-target="#nested-and-crossed-designs">Nested and crossed designs</a></li>
  <li><a href="#understand-what-you-are-doing" id="toc-understand-what-you-are-doing" class="nav-link" data-scroll-target="#understand-what-you-are-doing">Understand what you are doing!</a></li>
  </ul></li>
  <li><a href="#model-selection-and-comparisons-using-lrt" id="toc-model-selection-and-comparisons-using-lrt" class="nav-link" data-scroll-target="#model-selection-and-comparisons-using-lrt">Model selection and comparisons using LRT</a></li>
  <li><a href="#model-daignostic" id="toc-model-daignostic" class="nav-link" data-scroll-target="#model-daignostic">Model daignostic</a></li>
  <li><a href="#p-value-calculation-and-marginal-means" id="toc-p-value-calculation-and-marginal-means" class="nav-link" data-scroll-target="#p-value-calculation-and-marginal-means">P-value calculation and marginal means</a>
  <ul class="collapse">
  <li><a href="#anova-type-i-ii-and-iii" id="toc-anova-type-i-ii-and-iii" class="nav-link" data-scroll-target="#anova-type-i-ii-and-iii">ANOVA type I, II, and III</a></li>
  </ul></li>
  <li><a href="#power-calculation" id="toc-power-calculation" class="nav-link" data-scroll-target="#power-calculation">Power calculation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Mixed models</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>As briefly mentioned in the previous chapter, mixed-effects models (also known as multilevel or hierarchical models) are used introduce random effects to account for the cluster variations. This approach allows us to model the dependency structure due to clusters without having to estimate a separate parameter for each cluster effect. Mixed-effects models incorporate the clustering in the variance-covariance structure of the data, which provides a more parsimonious and interpretable model, especially when our primary interest lies in the fixed effects, such as the main effect of <code>Age</code> in the previous example.</p>
<p>Correlated is more common in biology than one might think. For example:</p>
<ul>
<li><p><strong>Repeated Measurements:</strong> Suppose you’re measuring a patient’s blood pressure over time. Measurements from the same patient will naturally be more similar to each other than those from different patients. A mixed-effects model handles this by modeling the variation between patients.</p></li>
<li><p><strong>Nested Designs:</strong> Imagine studying the effectiveness of a new drug on mice housed within different cages. Mice within the same cage might be more alike due to shared environments. A mixed-effects model accounts for both variation between mice and variation between cages.</p></li>
<li><p><strong>Longitudinal Studies:</strong> When tracking the growth of trees over time, measurements from the same tree will be more correlated than those from different trees. Here, a mixed-effects model can account for the individual tree’s growth patterns.</p></li>
<li><p><strong>Multi-omics Studies:</strong> Omics data (genomics, transcriptomics, proteomics, etc.) from the same individual will show correlations due to underlying biological pathways. A mixed-effects model can tease apart the effects of different omic layers while accounting for their relationships within a person.</p></li>
<li><p><strong>Family-based Disease Studies:</strong> Genetic variations and environmental exposures tend to cluster within families. Mixed-effects models can effectively model these familial factors when investigating how they contribute to disease risk.</p></li>
</ul>
<p>Mixed-effects models are a powerful tool for analyzing complex biological datasets, offering improved accuracy and providing valuable insights into the sources of variability in disease studies.</p>
<section id="why-mixed" class="level2">
<h2 class="anchored" data-anchor-id="why-mixed">Why “Mixed”?</h2>
<p>Mixed models get their name because they combine two types of effects: fixed effects and random effects. This combination is what makes them so valuable for analyzing complex data.</p>
<section id="fixed-effects" class="level3">
<h3 class="anchored" data-anchor-id="fixed-effects">Fixed Effects</h3>
<p>The statistical models you might be familiar with, like linear regression or ANOVA, focus on “fixed effects.” These are the direct relationships between your chosen variables and the outcome you’re interested in. Fixed effects are the factors you control or are primarily interested in. If you’re studying the effect of age on protein expression, age is your fixed effect. A fixed effect will contain all possible levels of a factor in the experiment, measuring a few specific instances of interest. The key premise of the fixed-effect model is that there is one true effect size that is common to all the studies being analyzed. This model assumes that any observed variation among study results is solely due to sampling error within studies, and not due to actual differences in effect sizes across studies. Therefore, the goal of a fixed-effect analysis is to estimate this common true effect size.</p>
<p>Let’s think about a research question asking if a specific vitamin supplement reduces the duration of common cold symptoms. Multiple clinical trials have been conducted to evaluate the effect of this vitamin supplement on the duration of common cold symptoms. Each trial uses the same dosage of the supplement and has similar participant demographics (e.g., age, health status). The researchers conducting the analysis believe that, given the standardized intervention and population, the supplement should have a consistent effect across all trials.</p>
<p><strong>Studies Reviewed:</strong> - Study 1: 100 participants, average reduction in symptom duration of 1.5 days. - Study 2: 150 participants, average reduction in symptom duration of 1.4 days. - Study 3: 120 participants, average reduction in symptom duration of 1.6 days. - Study 4: 130 participants, average reduction in symptom duration of 1.3 days.</p>
<p><strong>Fixed-Effect Model Assumptions in this Example:</strong></p>
<ul>
<li><strong>Single True Effect Size:</strong> The assumption here is that there is one true effect size reflecting the average reduction in the duration of common cold symptoms due to the vitamin supplement. This is based on the controlled administration of the supplement and the homogeneous nature of the participant groups across the trials.</li>
<li><strong>Variation Due to Sampling Error:</strong> The slight differences in observed effects among the studies (e.g., some showing a 1.3-day reduction while others show a 1.6-day reduction) are attributed to sampling error—random variation due to the different samples of participants in each study.</li>
<li><strong>Goal:</strong> To estimate the common true effect size of the vitamin supplement on reducing the duration of cold symptoms, a fixed-effect analysis is employed. This involves calculating a weighted average of the effect sizes from the individual trials, with greater weight given to larger trials since they are less prone to sampling error.</li>
</ul>
<p>Through the fixed-effect model analysis, it might be concluded that the specific vitamin supplement leads to an average reduction of approximately 1.4 days in the duration of common cold symptoms. This conclusion is based on the premise that the variation in results across the trials is solely due to sampling error, without accounting for potential underlying differences in participant response to the supplement, as such variability is assumed to be negligible given the standardized conditions of the trials.</p>
<p>The primary limitation of using a fixed-effect model, lies in its underlying assumptions about the homogeneity of effect sizes across studies. This model assumes that there is one true effect size that applies to all studies, and any observed variability in outcomes is solely due to sampling error. However, this assumption can be overly simplistic and may not always hold true, especially in biological and medical research where variability is the norm rather than the exception.</p>
</section>
<section id="random-effect" class="level3">
<h3 class="anchored" data-anchor-id="random-effect">Random effect</h3>
<p>The random-effects offer a more flexible and realistic approach, especially in contexts where between-study variability is expected or observed. The defining feature of the random-effects model is the assumption that there is a distribution of true effect sizes across studies, and the goal is to estimate the mean of this distribution. This approach accounts for variation not only within studies (due to sampling error) but also between studies, recognizing that different studies may inherently have different true effect sizes due to various factors (e.g., differences in populations, interventions, outcomes measured).</p>
<p>Returning to our scenario of evaluating the impact of a vitamin supplement on the duration of common cold symptoms, let’s consider that the clinical trials are conducted across various geographical locations, each with a distinct demographic and environmental profile. These location-based groups could inherently influence how participants respond to the supplement, independent of the supplement’s effect itself. We would introduce random intercepts for each geographical location. This means that while we are still interested in estimating the overall effect of the vitamin supplement on symptom duration, we also acknowledge that each location starts from a different baseline in terms of average symptom duration without the supplement. However, we actually don’t directly estimate these baselines but rather assume that these baselines are randomly samples from a distribution of baselines in the population with certain statistical properties. Therefore, we are not interested in each single baseline but we want to know statistical properties of the distribution of baselines.</p>
<p>In summary, the fixed-effect model’s generalization is limited to the “levels” within the experiment, meaning it applies to populations or conditions that exactly match those of the included studies. It treats the effect as if it were a fixed property of the specific scenarios tested. In contrast, the random-effects model allows for generalization to “levels beyond those that took part in the study,” acknowledging that the effect sizes are part of a distribution across a wider population. This model treats the effect as a variable property reflecting a range of possible scenarios, including those not directly observed in the analysis.</p>
<p>This might sounds too complicated or abstract. We are going to clarify this with a few examples.</p>
</section>
</section>
<section id="ingredients" class="level2">
<h2 class="anchored" data-anchor-id="ingredients">Ingredients</h2>
<p>In this section, we will try to clarify what information do we need in order to fit a linear model.</p>
<section id="grouping-structure-of-the-data" class="level3">
<h3 class="anchored" data-anchor-id="grouping-structure-of-the-data">Grouping Structure of the Data</h3>
<p>The first and most important thing is to understand the data we are dealing with. Before we can make any attempt to use mixed models, we need to know what kind of grouping structure we want to capture. Mixed models are particularly useful when data is collected in groups or clusters, such as measurements from different subjects, schools, geographical locations, or time points within subjects. Identifying the hierarchy or nested structure where observations are grouped within higher-level units is crucial. This grouping structure can significantly influence the correlations among observations, as data points within the same group are likely to be more similar to each other than to data points in different groups. Understanding this structure allows us to correctly model the random effects, which account for the variability at different levels of the data hierarchy, thereby improving the accuracy and interpretability of our results. By incorporating these random effects, mixed models enable us to make inferences about both the fixed effects, which are consistent across groups, and the random effects, which vary across groups.</p>
<p>Without having this information, we cannot use standard mixed models. This grouping must be categorical, not continuous, as mixed models rely on categorical variables to define the levels of the hierarchy or nested structure within the data. Categorical grouping allows us to classify observations into distinct categories or groups that share common characteristics.</p>
<p>It is obvious but worth mentioning that these grouping should not be confused with random effects.Random effects are calculated based on the assumption that data points within the same group may share more similarities with each other than with data points from different categories, thus accounting for the within-group correlation. Therefore, the identification of categorical groupings is not just a step in the analysis but a prerequisite for accurately calculating and interpreting the random effects that are fundamental to the mixed model’s approach to data analysis.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>You cannot use continuous data as grouping if it does not have levels. Without these discrete levels, it becomes impossible to define the clusters or hierarchies necessary for calculating random effects. To effectively employ mixed models, one must either use inherently categorical variables or discretize continuous variables into meaningful categories.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes it is not clear what grouping of data exist. Or even what should be used as grouping. In often (but not always), the grouping is something different than what we are interested in. For example, let’s say, we have gathered data from patients with a disease and attempted to find a matched control based on certain characteristics such as age, BMI etc. The group of interest here is disease vs.&nbsp;healthy and a possible grouping variable for random effect would be a match ID for the a each disease and its matched control.</p>
</div>
</div>
<p>The last thing i would like to mention is that, how many levels the random effect grouping should have in order to be included in the model. Although there is no golden consensus about it but most people tend to agree that the number levels of the group factor should be more than five to be accurately modeled by mixed models. Although some argue that with even two levels, mixed model will be like classical linear regression one should be extra cautious about it.</p>
</section>
<section id="design-for-fixed-and-random-effects" class="level3">
<h3 class="anchored" data-anchor-id="design-for-fixed-and-random-effects">Design for fixed and random effects</h3>
<p>Now that we have identified the grouping structure of the data, we need to decide what effects are fixed and what effects are random with respect to the grouping structure of the data. This is again might be confusing a bit but if we start asking ourselves a few questions, it might clarify the whole concept.</p>
<p>It is important to stress that the main reason we have chosen to go with mixed models is that we believe there is a grouping in our data that somehow affects some of the effects in our study. And by saying effect we mean the influence or impact that a particular variable has on the outcome of interest.</p>
<p>So here comes the first and a key question:</p>
<ol type="1">
<li><p><strong>Do we believe a particular effect varies across the grouping structure of the data?</strong> if we do not believe that a particular effect varies across the grouping structure of the data, then we may consider modeling this effect as a fixed effect <strong>without taking care of the grouping structure</strong>.</p>
<p>If the answer to this question is yes. Then we ask ourselves another key question.</p></li>
<li><p><strong>Are we interested in estimating the effect specific to the groups?</strong> Now that we have decided to take care of the grouping structure. We might be interested in estimating the effect of interest in each of groups or even compare them across the groups. You might want to even calculate p-values for these. If this is so then you might want to model these as fixed effect for example by including them as covariate (or blocking/control variable or even interaction) in the model. Doing so however, will force the model to estimate these effect thus spending degrees of freedom.</p>
<p>If however, we are still interested in taking care of the grouping but instead of estimating the effect in each group, we are happy just to know how much variability is in the effect of interest across the groups, then we are going to consider modeling that effect as random. This will instruct the modeling application to instead of estimating effects for each group (could be hundred of groups), just come up with estimates of few parameters showing the variability. Please note that these effects can be anything from baseline, slopes, interaction etc.</p></li>
<li><p><strong>Do we have a large number of groups, and are some of these groups potentially unobserved?</strong> Random effects models are particularly useful when dealing with a large number of groups, especially when some groups in the population might not be represented in the sample. Random effects assume that the observed groups are a random sample from a larger population of groups, allowing for generalization beyond the specific groups in the study.</p>
<p>However, as said before, instead of estimating parameters for each group, then calculate variance across the groups. If the number of levels in each group is too few (like two or something like that), the estimated variance is not going to be accurate. So you might want to actually get back and consider using classical models.</p></li>
</ol>
<p>By asking these questions, we can better clarify the roles of fixed and random effects. These things are going to be further clarified when we start working on a few examples.</p>
</section>
</section>
<section id="examples-mixed-models-in-r" class="level2">
<h2 class="anchored" data-anchor-id="examples-mixed-models-in-r">Examples (Mixed models in R )</h2>
<p>We get back our simulated data in the previous chapter and try to model it using mixed models. Before proceeding make sure that you have installed <code>lme4</code> package as this is what we are going to use throughout this section.</p>
<p>Just to remind you, the idea was to examine the relationship between Age and Protein expression.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>simulate_grouped_trend <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">group_count =</span> <span class="dv">5</span>, <span class="at">points_per_group =</span> <span class="dv">10</span>, <span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">global_intercept =</span> <span class="dv">30</span>, <span class="at">group_slope =</span> <span class="dv">2</span>, <span class="at">noise_sd =</span> <span class="dv">50</span>,<span class="at">noise_sd2=</span><span class="dv">2</span>) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Setting a seed for reproducibility</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame to store the simulated data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">numeric</span>(), <span class="at">y =</span> <span class="fu">numeric</span>())</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop to create each group</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>group_count) {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    x_start <span class="ot">&lt;-</span> <span class="dv">12</span> <span class="sc">+</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> (<span class="dv">10</span> <span class="sc">/</span> group_count) <span class="co"># Stagger the start of x for each group</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">runif</span>(points_per_group, <span class="at">min =</span> x_start, <span class="at">max =</span> x_start <span class="sc">+</span> (<span class="dv">10</span> <span class="sc">/</span> group_count))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply a local positive trend within the group, but maintain the global negative trend</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    local_intercept <span class="ot">&lt;-</span> global_intercept <span class="sc">+</span> global_slope <span class="sc">*</span> (x_start <span class="sc">+</span> (<span class="dv">10</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> group_count))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> noise_sd)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> local_intercept <span class="sc">+</span> group_slope[i] <span class="sc">*</span> (x <span class="sc">-</span> x_start) <span class="sc">+</span> <span class="fu">rnorm</span>(points_per_group, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> noise_sd2)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine this group with the overall dataset</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    group_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">y =</span> y,<span class="at">group=</span>i)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data, group_data)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># generate simulated data</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>data_int <span class="ot">&lt;-</span> <span class="fu">simulate_grouped_trend</span>(<span class="at">group_count =</span> <span class="dv">4</span>,<span class="at">points_per_group =</span> <span class="dv">10</span>,<span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">2</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,<span class="at">group_slope =</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>),<span class="at">noise_sd =</span> <span class="dv">5</span>,<span class="at">noise_sd2=</span><span class="dv">2</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># set group to factor</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>data_int<span class="sc">$</span>group <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_int<span class="sc">$</span>group)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the data</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x,data_int<span class="sc">$</span>y,<span class="at">xlab=</span><span class="st">"Age"</span>,<span class="at">ylab=</span><span class="st">"Protein expression"</span>,<span class="at">col=</span>data_int<span class="sc">$</span>group,<span class="at">pch=</span><span class="fu">as.numeric</span>(data_int<span class="sc">$</span>group))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: A scatter plot of Age vs.&nbsp;Protein expression
</figcaption>
</figure>
</div>
</div>
</div>
<p>Because there are some grouping structure in data, we decide to take care of it. Let’s say that each group is a random clinic that we decided to get some sample from. So we now have identified the grouping structure in our data that might influence the effect of interest (Age).</p>
<p>What we believe is that the effect of Age on the protein expression is constant in each of the groups. However, due to either technical issues with the instruments or even demographics, each group might have different baselines (starting point) for the protein expression. This gives us a hint that we might have to model <code>intercept</code> differently for each group. This decision gives us two choices, model this intercept as fixed or random effect.</p>
<p>Me as a researcher tell you in addition to the effect of age, I would like to know how much differences exactly are between each of these clinics. Therefore i want to use fixed effect to exactly pinpoint the estimated baseline for each of the clinic and compare them against each other.</p>
<p>You however, argue that there is no reason to do that. We just picked a few random clinics, there is no point in knowing by how much clinic 1 is different to clinic 2 because we could have selected and other random clinics in the world. So let’s model this as random effect to get the variance of the intercepts across clinics. By modeling the intercept as a random effect, we acknowledge that each clinic has its own baseline level of protein expression due to various unmeasured factors such as technical differences in equipment or demographic variations. This approach allows us to account for the inherent variability between clinics without focusing on the specific differences between any two clinics. Instead, we aim to understand the general variability of baseline protein expression levels across clinics.</p>
<p>We start using the classical approach (as we saw in the previous chapter) using <code>lm</code> function with the following formula <code>y ~ 1+x+group</code>:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We have included 1 in the model just to stress that there is an intercept in the model. Obviously, <code>y ~ 1+x+group</code> is identical to <code>y ~ x+group</code></p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>model_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>x<span class="sc">+</span>group, <span class="at">data =</span> data_int)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ 1 + x + group, data = data_int)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.9184 -1.7771 -0.1619  1.3793  5.2085 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  54.3746     8.0727   6.736 8.41e-08 ***
x             2.7260     0.5977   4.561 5.99e-05 ***
group2      -25.7602     1.6487 -15.625  &lt; 2e-16 ***
group3      -38.9476     3.2411 -12.017 5.62e-14 ***
group4      -44.7675     4.5867  -9.760 1.59e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.434 on 35 degrees of freedom
Multiple R-squared:  0.954, Adjusted R-squared:  0.9488 
F-statistic: 181.6 on 4 and 35 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>This model has four different intercepts, one for each group and a single slope that is identical for each group.</p>
<p>Given this result, we have estimated the group coefficients and we can go ahead with comparing the groups or do whatever we wanted to do with these estimates. It is important that here we don’t have a global slope. We have four slopes, one for each group.</p>
<p>Now it is time to do the same analysis using the mixed model approach. The model that we are going fit using <code>lmer</code> function from <code>lme4</code> is of form <code>y ~ 1+x+(1|group)</code>. This part of the model, <code>y ~ 1+x</code>, we already know what it is. However, what this part <code>(1|group)</code> is new. The right part of <code>|</code> shows what variable we want to use as grouping factor by which we are going to fit our random effect (That is the <code>group</code> in our case). The left part of <code>|</code> is the effect we want to consider random. The left part is like a formula, similar to classical regression. which in this case, we just used <code>1</code>. This means for our main model, <code>y ~ 1+x</code> which has an intercept (<code>1</code>) and a slope <code>x</code>, we would like to consider the intercept as random effect so we use <code>1</code>.</p>
<p>Now that we know the structure of the model, let’s go ahead and do the modeling:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a mixed linear regression model</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>model_lmm <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>x<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>group), <span class="at">data =</span> data_int)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_lmm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ 1 + x + (1 | group)
   Data: data_int

REML criterion at convergence: 201.4

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-1.68459 -0.76282 -0.09731  0.60068  2.18875 

Random effects:
 Groups   Name        Variance Std.Dev.
 group    (Intercept) 378.606  19.458  
 Residual               5.931   2.435  
Number of obs: 40, groups:  group, 4

Fixed effects:
            Estimate Std. Error t value
(Intercept)  29.9105    14.0125   2.135
x             2.5561     0.5892   4.339

Correlation of Fixed Effects:
  (Intr)
x -0.719</code></pre>
</div>
</div>
<p>This output has some key differences to the previous approach. The first thing is in the fixed effect part:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(<span class="fu">summary</span>(model_lmm))[[<span class="st">'coefficients'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Std. Error  t value
(Intercept) 29.910511  14.012502 2.134559
x            2.556149   0.589159 4.338640</code></pre>
</div>
</div>
<p>Unlike <code>lm</code>, here there is no estimate for each group. There is a single intercept and a single slope. These are <code>global</code> trends in the data with their corresponding <code>Std. Error</code> and <code>t value</code>. But what happen with random effect and grouping of the data. This is what we can see in the <code>Random effects</code> part of the output:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(<span class="fu">summary</span>(model_lmm))[[<span class="st">'varcor'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Groups   Name        Std.Dev.
 group    (Intercept) 19.4578 
 Residual              2.4355 </code></pre>
</div>
</div>
<p>Depending of what type of random effect we have been fitting this table can have different headers. But generally, <code>Groups</code>, <code>Name</code>, <code>Variance</code>, <code>Std.Dev.</code> and <code>Corr</code> are part of it.</p>
<p>Each row of this table correspond to a source of variation in our data that is random because of a certain reason. In our model, we decided to consider only <code>Intercept</code> as a random effect for <code>group</code>. Therefore, the first row of the table tells us that there is <strong>random</strong> variability in <code>Intercept</code> between different group. This variability is quantified by a variance of 378.606 and a standard deviation of 19.458. This means that the average effect (or intercept) across groups can deviate from the overall (<code>global</code>) intercept by about 19.458 units, indicating substantial between-group variability. This is important to note that, we have actually never estimated any intercept for each group directly. But we have estimated the variability of intercepts across different groups, which allows us to account for the fact that each group may have a different starting point or baseline level in the response variable, even though these specific baseline levels are not directly calculated. You can think about this as the variance of the distribution of intercepts across the groups. Essentially, we’re modeling the distribution from which each group’s intercept is drawn.</p>
<p>The second row, labeled <code>Residual</code>, refers to the variability within each group that is not explained by the model predictors (because of random sampling). The variance here is 5.931, with a standard deviation of 2.435. This residual variance represents the individual differences or noise within groups after accounting for the modeled effects, including the random intercepts.</p>
<p>So before moving on let’s summarize what get got so far.</p>
<p>We used mixed models with a <strong>random intercept</strong> to model the effect of age on protein expression. We got an estimated global intercept (baseline) and slope (main effect of interest). We took care of the grouping structure of our data without directly estimating any additional parameters. In fact, what we estimated was <code>intercept</code>, <code>slope</code>, <code>variance of Intercept</code> and <code>variance of residuals</code>. One of the coolest thing here is that we would have estimated the exact same number of parameters if our grouping structure had a lot more levels. But if we want to use grouping as covariate (in a classic model), we should have modeled all of those levels!</p>
<section id="predicting-the-random-intercept" class="level3">
<h3 class="anchored" data-anchor-id="predicting-the-random-intercept">Predicting the random intercept</h3>
<p>Despite that we have not estimated the intercept for each of the group, we can still predict what would the intercept be for each of the groups. We are going to see in the math section how that can be done, but for now, we skip the details and directly use the function <code>ranef</code> from <code>lme4</code> package.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">ranef</span>(model_lmm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$group
  (Intercept)
1   26.705636
2    1.337016
3  -11.314930
4  -16.727722

with conditional variances for "group" </code></pre>
</div>
</div>
<p>In this particular case, it gave us the differences from the overall intercept estimated in the mixed effects model. By extracting the random effects using the <code>ranef</code> function, we obtain the specific adjustments needed for each group. We can now use the global intercept and these adjustments to visualize the predicted intercept.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the initial scatter plot with points colored by group and shape determined by group</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span>data_int<span class="sc">$</span>group, <span class="at">pch=</span><span class="fu">as.numeric</span>(data_int<span class="sc">$</span>group))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Looping through each unique group in the dataset</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (group <span class="cf">in</span> <span class="fu">unique</span>(data_int<span class="sc">$</span>group)) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset data for the current group</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  group_data <span class="ot">&lt;-</span> data_int[data_int<span class="sc">$</span>group <span class="sc">==</span> group,]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the intercept for the group by adding the fixed intercept to the group's random effect</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">ranef</span>(model_lmm)[[<span class="dv">1</span>]][group, <span class="dv">1</span>]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the fixed effect slope from the model</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">2</span>]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a line for the group using the calculated intercept and slope</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">y =</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> group_data<span class="sc">$</span>x, <span class="at">x =</span> group_data<span class="sc">$</span>x, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a global effect line using the fixed effect intercept and slope from the model</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">1</span>], <span class="at">b =</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding a legend to the plot</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>legend_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Global Effect"</span>, <span class="st">"Random Intercept"</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> legend_labels, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Scatter plot of Age vs.&nbsp;Protein expression per group with random intercept
</figcaption>
</figure>
</div>
</div>
</div>
<p>Here we have plotted best unbiased estimated trend per group and also the global trend. We can see that all the lines are parallel (as we still did not model slope per group) and there is a deviation of slope in each of the groups compared to the global trend.</p>
<p>Looking at <a href="#fig-scatter-plot-grouped-lmm" class="quarto-xref">Figure&nbsp;<span>2</span></a>, we can see that a lot of variation is because of the differences between the groups. This is exactly what the variance component of the mixed model showed us. The ratio of random intercept and the total variance quantifies how much of the total variability in the outcome is due to variability between groups: <span class="math inline">\(\frac{378.606}{5.931+378.606}=98.46\%\)</span>. So most of the variation in the data is because of the differences between the groups.</p>
</section>
<section id="random-slope" class="level3">
<h3 class="anchored" data-anchor-id="random-slope">Random slope</h3>
<p>So far we have the random intercept model, however, one can argue that the effect of age on protein expression might not be uniform across all clinics. This variability suggests that we should also consider modeling the slope as a random effect, allowing the relationship between age and protein expression to vary among the groups. This leads us to a more complex but potentially more accurate model: <code>y ~ 1+x+(1+x|group)</code>. In this model, not only the intercepts are allowed to vary randomly across clinics (<code>1</code> part of the the model), but also the slopes (<code>x</code>). This basically says that each clinic might not only have a different starting point of protein expression but also a different rate at which protein expression changes with age.</p>
<p>Implementing a random slope model accommodates the hypothesis that the effect of age could be influenced by factors specific to each clinic, such as demographic characteristics, environmental factors, or other clinic-specific variables not captured in the dataset.</p>
<p>To fit this model, we modify our <code>lmer</code> function call as follows:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a mixed linear regression model with random slopes</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>model_lmm_rs <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>x<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>x<span class="sc">|</span>group), <span class="at">data =</span> data_int)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_lmm_rs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ 1 + x + (1 + x | group)
   Data: data_int

REML criterion at convergence: 186.8

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-1.56057 -0.74656 -0.02922  0.26277  2.22754 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 group    (Intercept) 344.655  18.565        
          x             5.141   2.267   -0.93
 Residual               3.672   1.916        
Number of obs: 40, groups:  group, 4

Fixed effects:
            Estimate Std. Error t value
(Intercept)   35.321     11.977   2.949
x              2.538      1.220   2.080

Correlation of Fixed Effects:
  (Intr)
x -0.904</code></pre>
</div>
</div>
<p>In the output, we see not just the variance and standard deviation for the intercepts across groups, but also for the slopes. This allows us to quantify how much variation there is in the relationship between age and protein expression across the different clinics.</p>
<p>Looking at fixed effect, we still have the global intercept and slope. There is a small change compared to the previous model but the major change now is in the random effect part.</p>
<p>The <code>Random effects</code> section of the model summary now includes information about the variability in slopes in addition to the intercepts.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">VarCorr</span>(model_lmm_rs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Groups   Name        Std.Dev. Corr  
 group    (Intercept) 18.5649        
          x            2.2675  -0.933
 Residual              1.9164        </code></pre>
</div>
</div>
<p>We still have the major source of variation in our data caused by <code>Intercept</code> and a smaller, but still present, variability in how age affects protein expression across these clinics (the slope <code>x</code>).</p>
<p>A high correlation between the intercept and slope within the random effects suggests a linear relationship in the random part of the model. This indicates that clinics with higher baseline protein expression also have a stronger positive relationship between age and protein expression.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the initial scatter plot with points colored by group and shape determined by group</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span>data_int<span class="sc">$</span>group, <span class="at">pch=</span><span class="fu">as.numeric</span>(data_int<span class="sc">$</span>group))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Looping through each unique group in the dataset</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (group <span class="cf">in</span> <span class="fu">unique</span>(data_int<span class="sc">$</span>group)) {</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset data for the current group</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  group_data <span class="ot">&lt;-</span> data_int[data_int<span class="sc">$</span>group <span class="sc">==</span> group,]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the intercept for the group by adding the fixed intercept to the group's random effect</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">ranef</span>(model_lmm_rs)[[<span class="dv">1</span>]][group, <span class="dv">1</span>]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the fixed effect slope from the model</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">2</span>]<span class="sc">+</span><span class="fu">ranef</span>(model_lmm_rs)[[<span class="dv">1</span>]][group, <span class="dv">2</span>]</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a line for the group using the calculated intercept and slope</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">y =</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> group_data<span class="sc">$</span>x, <span class="at">x =</span> group_data<span class="sc">$</span>x, <span class="at">col =</span> <span class="st">"green"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">ranef</span>(model_lmm)[[<span class="dv">1</span>]][group, <span class="dv">1</span>]</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the fixed effect slope from the model</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">2</span>]</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">y =</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> group_data<span class="sc">$</span>x, <span class="at">x =</span> group_data<span class="sc">$</span>x, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a global effect line using the fixed effect intercept and slope from the model</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">1</span>], <span class="at">b =</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding a legend to the plot</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>legend_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Global Effect"</span>, <span class="st">"Random Intercept"</span>, <span class="st">"Random Intercep and slope"</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> legend_labels, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>,<span class="st">"green"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-rs" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-rs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-rs-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-rs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Scatter plot of Age vs.&nbsp;Protein expression per group with random intercept and slope
</figcaption>
</figure>
</div>
</div>
</div>
<p>The plot above illustrates the variability in protein expression as a function of age across different clinics. The blue line indicates the overall trend across all clinics (Global Effect), while the red and green lines represent individual clinic trends. The red lines show the clinic-specific adjustments to the overall intercept (Random Intercept), indicating that some clinics, on average, have higher or lower protein expression regardless of age. The green lines show both clinic-specific intercepts and slopes (Random Intercept and Slope), suggesting that the rate at which protein expression changes with age also varies by clinic. This visual representation underscores the importance of accounting for random effects in the model, as it captures the ways in which age influences protein expression across diverse clinical settings.</p>
<p>In this specific case, the global estimated intercept and slope did not change that much compared to the random intercept model. However, in the cases that there is a very large deviation between slopes of different groups, the global coefficient can be much more impacted.</p>
</section>
<section id="nested-and-crossed-designs" class="level3">
<h3 class="anchored" data-anchor-id="nested-and-crossed-designs">Nested and crossed designs</h3>
<p>So far we have seen pretty simple cases of two level models. However, mixed models can be used to handle pretty complex experimental designs. Here i will try to give you a few examples of what you can do with these models and how to interpret them.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We are going to repeat this later but the type of design is not something that should be inferred based on the data. Despite that this is possible and might seem reasonable to do so, especially nested and crossed designs musted supported by the experimental designs</p>
</div>
</div>
<section id="nested-designs" class="level4">
<h4 class="anchored" data-anchor-id="nested-designs">Nested designs</h4>
<p>Nested designs occur when one level of grouping is entirely contained within another level, without any overlap between groups at the same level. In the context of mixed models, this translates to data where, for instance, patients are grouped within clinics, and clinics are grouped within regions Each patient belongs to one and only one clinic, and each clinic belongs to one and only one region. The key characteristic of nested designs is that the groups at one level do not intersect or overlap with groups at another level.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    A[Region 1] 
    A --&gt; B[Clinic 1]
    A --&gt; C[Clinic 2]
    A --&gt; D[Clinic 3]
    
    B -.-&gt; M1[Patient 1]
    B -.-&gt; N2[Patient 2]
    B -.-&gt; O3[Patient 3]

    C -.-&gt; P4[Patient 4]
    C -.-&gt; Q5[Patient 5]
    C -.-&gt; R6[Patient 6]
    
    D -.-&gt; S7[Patient 7]
    D -.-&gt; T8[Patient 8]
    D -.-&gt; U9[Patient 9]

    E[Region 2]
    E --&gt; F[Clinic 4]
    E --&gt; G[Clinic 5]
    E --&gt; H[Clinic 6]
    
    F -.-&gt; V10[Patient 10]
    F -.-&gt; W11[Patient 11]
    F -.-&gt; X12[Patient 12]

    G -.-&gt; Y13[Patient 13]
    G -.-&gt; Z14[Patient 14]
    G -.-&gt; A15[Patient 15]
    
    H -.-&gt; B16[Patient 16]
    H -.-&gt; C17[Patient 17]
    H -.-&gt; D18[Patient 18]

    I[Region 3]
    I --&gt; J[Clinic 7]
    I --&gt; K[Clinic 8]
    I --&gt; L[Clinic 9]
    
    J -.-&gt; E19[Patient 19]
    J -.-&gt; F20[Patient 20]
    J -.-&gt; G21[Patient 21]

    K -.-&gt; H22[Patient 22]
    K -.-&gt; I23[Patient 23]
    K -.-&gt; J24[Patient 24]
    
    L -.-&gt; K25[Patient 25]
    L -.-&gt; L26[Patient 26]
    L -.-&gt; M27[Patient 27]

    classDef region fill:#f9f,stroke:#333,stroke-width:2px;
    classDef clinic fill:#ccf,stroke:#333,stroke-width:2px;
    classDef patient fill:#cff,stroke:#333,stroke-width:1px;
    
    class A,E,I region;
    class B,C,D,F,G,H,J,K,L clinic;
    class M1,N2,O3,P4,Q5,R6,S7,T8,U9,V10,W11,X12,Y13,Z14,A15,B16,C17,D18,E19,F20,G21,H22,I23,J24,K25,L26,M27 patient;

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="interpreting-nested-designs" class="level4">
<h4 class="anchored" data-anchor-id="interpreting-nested-designs">Interpreting Nested Designs</h4>
<p>In nested designs, the analysis aims to account for the variability at each level of the hierarchy. For example, when assessing the effect of age on protein expression, a nested model allows for the separation of the variability attributable to differences between regions, differences between clinics within regions, and individual differences between patients within clinic. This separation is crucial for accurately estimating the effects of interest (e.g., age) while controlling for the hierarchical structure of the data.</p>
<p>Nested models are particularly powerful for:</p>
<ul>
<li><strong>Identifying Variability:</strong> They help in identifying where the most significant sources of variability lie within the hierarchical structure. Is it between regions, between clinics within regions, or within regions?</li>
<li><strong>Improving Estimates:</strong> By correctly modeling the nested structure, we obtain more accurate estimates of group-level effects and individual effects. This is because the model accounts for the correlation within groups, leading to better estimates of the standard errors for the fixed effects.</li>
<li><strong>Customizing Interventions:</strong> In life science research, for example, understanding the level at which interventions are most effective (regions vs.&nbsp;clinics) can inform targeted strategies for improvement.</li>
</ul>
</section>
<section id="example" class="level4">
<h4 class="anchored" data-anchor-id="example">Example</h4>
<p>In R (<code>lmer</code>), we can use <code>(1 | regions/clinics)</code> for samples nested within clinic, which are in turn nested within regions.</p>
<p>Let’s see one example:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>simulate_grouped_trend_nested <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">region_count =</span> <span class="dv">3</span>, <span class="at">clinics_per_region =</span> <span class="dv">5</span>, <span class="at">measurements_per_clinic =</span> <span class="dv">10</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">global_intercept =</span> <span class="dv">30</span>, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">region_effects =</span> <span class="fu">c</span>(), <span class="at">region_slopes =</span> <span class="fu">c</span>(),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">clinic_effects =</span> <span class="fu">list</span>(), <span class="at">clinic_slopes =</span> <span class="fu">list</span>()) {</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Setting a seed for reproducibility</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame to store the simulated data</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">numeric</span>(), <span class="at">y =</span> <span class="fu">numeric</span>(), <span class="at">clinic =</span> <span class="fu">integer</span>(), <span class="at">region =</span> <span class="fu">integer</span>())</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  clinic_id_counter <span class="ot">=</span> <span class="dv">1</span> <span class="co"># Initialize a counter for clinic IDs across regions</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop to create data for each region</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (region <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>region_count) {</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the specific region effect and slope</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    region_effect_adj <span class="ot">=</span> region_effects[region]</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    region_slope_adj <span class="ot">=</span> region_slopes[region]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop to create data for each clinic within a region</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (clinic <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>clinics_per_region) {</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      x_start <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10</span>) <span class="sc">+</span> <span class="dv">10</span> <span class="sc">*</span> (clinic <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># More continuous x values across clinics</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      x <span class="ot">=</span> <span class="fu">runif</span>(measurements_per_clinic, <span class="at">min =</span> x_start, <span class="at">max =</span> x_start <span class="sc">+</span> <span class="dv">10</span>) <span class="co"># Continuous x for measurements</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use the specific clinic effect and slope</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      clinic_effect <span class="ot">=</span> clinic_effects[[region]][clinic]</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>      clinic_slope <span class="ot">=</span> clinic_slopes[[region]][clinic]</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Simulate measurements for each clinic</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>measurements_per_clinic) {</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Model y incorporating both global and specific slopes and effects</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        y <span class="ot">=</span> (global_intercept <span class="sc">+</span> region_effect_adj <span class="sc">+</span> clinic_effect) <span class="sc">+</span> </span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>            (global_slope <span class="sc">+</span> region_slope_adj <span class="sc">+</span> clinic_slope) <span class="sc">*</span> x[i] <span class="sc">+</span> </span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Assuming measurement_noise_sd is constant for simplicity</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine this measurement with the overall dataset</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">=</span> <span class="fu">rbind</span>(data, <span class="fu">data.frame</span>(<span class="at">x =</span> x[i], <span class="at">y =</span> y, <span class="at">clinic =</span> clinic_id_counter, <span class="at">region =</span> region))</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>      clinic_id_counter <span class="ot">&lt;-</span> clinic_id_counter <span class="sc">+</span> <span class="dv">1</span> <span class="co"># Increment clinic ID for unique identification across regions</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>data_int_nested<span class="ot">&lt;-</span><span class="fu">simulate_grouped_trend_nested</span>(<span class="at">region_count =</span> <span class="dv">4</span>,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinics_per_region =</span> <span class="dv">3</span>,</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">measurements_per_clinic =</span> <span class="dv">20</span>,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">global_slope =</span> <span class="dv">0</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">region_effects =</span> <span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="at">mean =</span> <span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">20</span>),</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">region_slopes=</span><span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="at">mean =</span> <span class="fl">0.1</span>,<span class="at">sd =</span> <span class="dv">2</span>),</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>       <span class="at">clinic_effects =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="cf">function</span>(i){<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="at">mean =</span> <span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">10</span>)}),</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">clinic_slopes =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="cf">function</span>(i){<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="at">mean =</span> <span class="fl">0.1</span>,<span class="at">sd =</span> <span class="dv">1</span>)}))</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int_nested<span class="sc">$</span>x,data_int_nested<span class="sc">$</span>y,<span class="at">col=</span>data_int_nested<span class="sc">$</span>region,<span class="at">pch=</span>data_int_nested<span class="sc">$</span>clinic,<span class="at">xlab =</span> <span class="st">"Age"</span>,<span class="at">ylab =</span> <span class="st">"Protein expression"</span>)</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Region"</span>, <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>region)),</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>region), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Regions"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Clinic"</span>, <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>clinic)),</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>clinic), <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Clinics"</span>, <span class="at">inset =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-nested" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-nested-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-nested-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-nested-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Scatter plot of Age vs.&nbsp;Protein expression for nested design
</figcaption>
</figure>
</div>
</div>
</div>
<p>In this example, we simulated a number of samples from a few clinics from different regions. From the beginning the experimental design was nested in a way that, a single sample was from a single clinic and a single clinc was from one and only one region. Looking at <a href="#fig-scatter-plot-grouped-lmm-nested" class="quarto-xref">Figure&nbsp;<span>4</span></a>, we can already see that there is a very big baseline difference between regions. Within each region, there is also some baseline differences between clinics but it is less dominant than the region differences. Furthermore, the effect of Age on Protein expression seems to be different slightly across different regions (some have positive effect, some negative and some close to zero) and to a lesser extend within each region but across clinics. Given this informal interpretation of the data we go forward and do the modeling considering both the intercept and slope as random effects.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model_lmm_nested <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y<span class="sc">~</span>x<span class="sc">+</span>(x<span class="sc">|</span>region<span class="sc">/</span>clinic),data_int_nested)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_nested)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (x | region/clinic)
   Data: data_int_nested
REML criterion at convergence: 859.4597
Random effects:
 Groups        Name        Std.Dev. Corr 
 clinic:region (Intercept)  8.124        
               x            1.104   -0.31
 region        (Intercept) 19.610        
               x            2.572   -0.25
 Residual                   1.042        
Number of obs: 240, groups:  clinic:region, 12; region, 4
Fixed Effects:
(Intercept)            x  
    100.915        0.337  </code></pre>
</div>
</div>
<p>This result is slightly different to what we have seen before using only a single grouping factor. Now we have <strong>clinic within region (clinic:region)</strong> in which the model estimates random intercepts and slopes for clinics nested within regions. This reflects the variability in baseline Protein expression and the effect of Age on Protein expression at the clinic level, indicating that clinics within the same region may still exhibit unique characteristics. The model also estimates random intercepts and slopes at the <strong>region</strong> level, capturing broader variations across regions. This indicates how different regions can have distinct baseline Protein expressions and different relationships between Age and Protein expression.</p>
<p>The model identifies significant variability in baseline Protein expression levels across regions, as indicated by the standard deviation of the intercepts for regions. This variability signifies that different regions start off with different baseline Protein expressions. There’s additional variability at the clinic level within each region, though this effect is smaller compared to the variability between regions.</p>
<p>The slopes, representing the effect of Age on Protein expression, also vary by region and by clinic within regions. This variation in slopes indicates that the relationship between Age and Protein expression is not uniform; it changes from one region to another and even among clinics within the same region. Some regions or clinics might show a positive relationship (increasing Age associated with higher Protein expression), while others show a negative or negligible relationship.</p>
<p>Similar to what we have seen before, the model provides a correlation coefficient between the intercept and slope within clinics nested in regions. A negative correlation suggests that clinics with higher baseline Protein expression tend to have a less steep (or more negative) Age effect, or vice versa.</p>
<p>Finally, the fixed effect intercept represents the average baseline level of Protein expression when Age is zero, pooled across all regions and clinics. This gives a general starting point for Protein expression across the dataset. And the fixed effect slope indicates the average effect of Age on Protein expression, again pooled across the entire dataset. This effect sizes up the general tendency of how Protein expression changes with Age, irrespective of the region or clinic.</p>
</section>
<section id="crossed-designs" class="level4">
<h4 class="anchored" data-anchor-id="crossed-designs">Crossed designs</h4>
<p>The last experimental design I want to mention is the full crossed design, which contrasts with the nested structure we’ve explored so far. In a crossed design, each level of one grouping factor can be combined with each level of another grouping factor, creating a matrix-like structure of group combinations. This design is particularly relevant in experiments where the interaction effects between two or more independent grouping factors are of interest, and these factors are not hierarchically related but rather orthogonal or independent of each other.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD

    A[Clinic 1]
    E[Clinic 2]
    I[Clinic 3]

    B[Doctor 1]
    C[Doctor 2]
    D[Doctor 3]

    M1[Sample 1]
    M2[Sample 2]
    M3[Sample 3]
    M4[Sample 4]
    M5[Sample 5]
 

    A -.-&gt; B
    A -.-&gt; C
    A -.-&gt; D
    E -.-&gt; B
    E -.-&gt; C
    E -.-&gt; D
    I -.-&gt; B
    I -.-&gt; C
    I -.-&gt; D
   
    %% Patients connected to clinics to show they can come from any clinic, implying crossed with regions
    B --&gt; M1
    B --&gt; M2
    B --&gt; M3
    B --&gt; M4
    B --&gt; M5
    
    C --&gt; M1
    C --&gt; M2
    C --&gt; M3
    C --&gt; M4
    C --&gt; M5
    
    D --&gt; M1
    D --&gt; M2
    D --&gt; M3
    D --&gt; M4
    D --&gt; M5
    
    %% Additional patient connections omitted for brevity

    classDef region fill:#f9f,stroke:#333,stroke-width:2px;
    classDef clinic fill:#ccf,stroke:#333,stroke-width:2px;
    classDef patient fill:#cff,stroke:#333,stroke-width:1px;
    
    class A,E,I region;
    class B,C,D,F,G,H,J,K,L clinic;
    class M1,M2,M3,M4,M5 patient;
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>One hypothetical study (probably very rare!) is a study designed to explore the effects of age on protein expression within a single patient, our research employs a unique crossed design where the patient visits multiple doctors across various clinics at different ages. Recognizing the potential for variability introduced by the differing methodologies and environments inherent to each clinic, as well as the distinct clinical approaches of each doctor. Specifically, we want to analyze the data, treating age as a continuous fixed effect to investigate its influence on protein expression. Concurrently, we model doctors and clinics as random effects to account for the variability they introduce into the protein expression measurements. This allows us not only to assess the general trend of protein expression changes over time but also to explore how these changes might be modulated differently across the various clinical settings and by different medical professionals.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>simulate_grouped_trend_crossed <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">clinic_count =</span> <span class="dv">3</span>, <span class="at">doctor_count =</span> <span class="dv">5</span>, <span class="at">measurements_per_combination =</span> <span class="dv">10</span>,</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">global_intercept =</span> <span class="dv">30</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">clinic_effects =</span> <span class="fu">c</span>(), <span class="at">clinic_slopes =</span> <span class="fu">c</span>(),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">doctor_effects =</span> <span class="fu">c</span>(), <span class="at">doctor_slopes =</span> <span class="fu">c</span>()) {</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Setting a seed for reproducibility</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame to store the simulated data</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">numeric</span>(), <span class="at">y =</span> <span class="fu">numeric</span>(), <span class="at">doctor =</span> <span class="fu">integer</span>(), <span class="at">clinic =</span> <span class="fu">integer</span>())</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate or adjust lengths of effects and slopes arrays to match counts</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(clinic_effects) <span class="sc">!=</span> clinic_count) clinic_effects <span class="ot">&lt;-</span> <span class="fu">rep</span>(clinic_effects[<span class="dv">1</span>], clinic_count)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(clinic_slopes) <span class="sc">!=</span> clinic_count) clinic_slopes <span class="ot">&lt;-</span> <span class="fu">rep</span>(clinic_slopes[<span class="dv">1</span>], clinic_count)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(doctor_effects) <span class="sc">!=</span> doctor_count) doctor_effects <span class="ot">&lt;-</span> <span class="fu">rep</span>(doctor_effects[<span class="dv">1</span>], doctor_count)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(doctor_slopes) <span class="sc">!=</span> doctor_count) doctor_slopes <span class="ot">&lt;-</span> <span class="fu">rep</span>(doctor_slopes[<span class="dv">1</span>], doctor_count)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop to create data for each combination of clinic and doctor</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (clinic <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>clinic_count) {</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (doctor <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>doctor_count) {</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>      x_start <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10</span>) <span class="co"># Continuous x values</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>      x <span class="ot">=</span> <span class="fu">runif</span>(measurements_per_combination, <span class="at">min =</span> x_start, <span class="at">max =</span> x_start <span class="sc">+</span> <span class="dv">10</span>) <span class="co"># Continuous x for measurements</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use the specific effect and slope for the current clinic and doctor</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>      clinic_effect_adj <span class="ot">=</span> clinic_effects[clinic]</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      clinic_slope_adj <span class="ot">=</span> clinic_slopes[clinic]</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>      doctor_effect <span class="ot">=</span> doctor_effects[doctor]</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>      doctor_slope <span class="ot">=</span> doctor_slopes[doctor]</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Simulate measurements for each combination of clinic and doctor</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>measurements_per_combination) {</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Model y incorporating both global and specific slopes and effects</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        y <span class="ot">=</span> (global_intercept <span class="sc">+</span> clinic_effect_adj <span class="sc">+</span> doctor_effect) <span class="sc">+</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>            (global_slope <span class="sc">+</span> clinic_slope_adj <span class="sc">+</span> doctor_slope) <span class="sc">*</span> x[i] <span class="sc">+</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Assuming measurement_noise_sd is constant for simplicity</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine this measurement with the overall dataset</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">=</span> <span class="fu">rbind</span>(data, <span class="fu">data.frame</span>(<span class="at">x =</span> x[i], <span class="at">y =</span> y, <span class="at">doctor =</span> doctor, <span class="at">clinic =</span> clinic))</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>data_int_crossed<span class="ot">&lt;-</span><span class="fu">simulate_grouped_trend_crossed</span>(<span class="at">clinic_count =</span> <span class="dv">4</span>,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">doctor_count =</span> <span class="dv">3</span>,</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">measurements_per_combination =</span> <span class="dv">20</span>,</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">global_slope =</span> <span class="dv">1</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinic_effects =</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">60</span>),</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinic_slopes=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.5</span>,<span class="fl">0.9</span>,<span class="fl">1.1</span>),</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>       <span class="at">doctor_effects =</span> <span class="fu">c</span>(<span class="fl">1.3</span>,<span class="fl">1.2</span>,<span class="dv">2</span>),</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">doctor_slopes =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(data_int_crossed<span class="sc">$</span>x,data_int_crossed<span class="sc">$</span>y,<span class="at">col=</span>data_int_crossed<span class="sc">$</span>clinic,<span class="at">pch=</span>data_int_crossed<span class="sc">$</span>doctor,<span class="at">xlab =</span> <span class="st">"Age"</span>,<span class="at">ylab =</span> <span class="st">"Protein expression"</span>)</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Clinic"</span>, <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>clinic)),</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>clinic), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Clinics"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Doctor"</span>, <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>doctor)),</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>doctor), <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Doctors"</span>, <span class="at">inset =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-crossed" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-crossed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-crossed-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-crossed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Scatter plot of Age vs.&nbsp;Protein expression for crossed design
</figcaption>
</figure>
</div>
</div>
</div>
<p>Ok! Now it is a bit more complicated that before. What <a href="#fig-scatter-plot-grouped-lmm-crossed" class="quarto-xref">Figure&nbsp;<span>5</span></a> tells us is that There appears to be quite a big differences in baseline between different clinics (colors). The effect of age on protein expression seems to be consistently go up in each clinic. However, looking at the doctors (shapes), we see that all three of them are quite consistent when it comes to baseline but one of them has a big slope differences compare to the other two.</p>
<p>Basically, the results of modeling tells us the same thing:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>model_lmm_crossed <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y<span class="sc">~</span>x<span class="sc">+</span>(x<span class="sc">|</span>clinic)<span class="sc">+</span>(x<span class="sc">|</span>doctor),data_int_crossed)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_crossed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (x | clinic) + (x | doctor)
   Data: data_int_crossed
REML criterion at convergence: 732.3083
Random effects:
 Groups   Name        Std.Dev. Corr 
 clinic   (Intercept) 25.5179       
          x            0.2434  -0.17
 doctor   (Intercept)  0.4460       
          x            2.6332  0.82 
 Residual              0.9559       
Number of obs: 240, groups:  clinic, 4; doctor, 3
Fixed Effects:
(Intercept)            x  
    131.832        2.108  </code></pre>
</div>
</div>
<p>The interpretation is the same as before, we have three kind of variations in both slopes and intercept. Between doctors, between clinics and of course the residuals. The largest variance is between the clinics in their baseline followed by the slope of doctors.</p>
<p>That of more or less what the crossed design looks like. It is important to note that, you <strong>should not</strong> model the crossed designs using the nested formula. Using a nested random effects notation like <code>(x | clinic:doctor)</code> implies a nested structure where each “doctor” is considered to be unique within each “clinic” and does not account for the possibility of the same doctor working across multiple clinics. This notation inherently assumes that each doctor-clinic combination is distinct and treats “doctor” identities as separate within each clinic, without recognizing that a single doctor could contribute data across different clinics. Modeling crossed factors using nested notation can inadvertently obscure the independence of those factors and the data’s true structure. As a result, it introduces structural biases in the analysis, potentially leading to incorrect conclusions about the effects of interest and the variability within and across the groups.</p>
<p>So to summarize, the crossed design does not assume any particular relationship between region and clinic. They are just two separate sources of random variability. This could be appropriate in a design where doctors from the same clinic could be more similar to each other, but a doctor could theoretically belong to any clinic.</p>
<p>The nested design assumes that doctors are nested within clinics. This introduces additional structure to the random effects, where the variability at the doctor level is specific to each clinic. This model is used in designs, where the data from doctors are grouped by clinics, and you expect that doctors within the same clinic share some commonality that is different from doctors in other clinics.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>One way to make sure that you are using the correct formulation of the random effect is to ask yourself whether this is design is nested or not. If the design is not nested you should use the crossed formulation.</p>
<p>For example for smaller designs we can check using <code>xtabs</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">xtabs</span>(<span class="sc">~</span>region<span class="sc">+</span>clinic,data_int_nested))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      clinic
region  1  2  3  4  5  6  7  8  9 10 11 12
     1 20 20 20  0  0  0  0  0  0  0  0  0
     2  0  0  0 20 20 20  0  0  0  0  0  0
     3  0  0  0  0  0  0 20 20 20  0  0  0
     4  0  0  0  0  0  0  0  0  0 20 20 20</code></pre>
</div>
</div>
<p>and compare to a crossed design</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">xtabs</span>(<span class="sc">~</span>clinic<span class="sc">+</span>doctor,data_int_crossed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      doctor
clinic  1  2  3
     1 20 20 20
     2 20 20 20
     3 20 20 20
     4 20 20 20</code></pre>
</div>
</div>
<p>We can see that in the first example, each lower level grouping factor (in this case <code>clinic</code>) is only associated to one and only one <code>region</code>. But a <code>region</code> can accommodate multiple clinics. This is nested. However, in the second example, we have each <code>doctor</code> (lower level) associated with multiple <code>clinics</code>. This violates the assumptions of nesting and therefore is crossed.</p>
<p>There exist much more complex designs, but we are not going to cover them here.</p>
</div>
</div>
</section>
</section>
<section id="understand-what-you-are-doing" class="level3">
<h3 class="anchored" data-anchor-id="understand-what-you-are-doing">Understand what you are doing!</h3>
<p>Statistical models can become very complex especially when many variables of different types (countinous, categorical etc) are of interest or one is to look at interactions. What we want to do here in this section is to explore a few cases that involve creating models of more than one variable.</p>
<p>Consider a simple scenario where some patients have been given three treatments by different doctors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>simulatePatientData_treatment_doctor <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">numDoctors =</span> <span class="dv">30</span>, <span class="at">numPatients =</span> <span class="dv">10</span>, <span class="at">seed =</span> <span class="dv">12345</span>) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">=</span> <span class="dv">50</span>  <span class="co"># Baseline recovery time</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  treatmentEffect <span class="ot">=</span> <span class="fu">c</span>(<span class="at">A =</span> <span class="dv">0</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">C =</span> <span class="sc">-</span><span class="dv">20</span>)  <span class="co"># Treatment effect on recovery time</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate data</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  doctors <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>numDoctors, <span class="at">each =</span> numPatients)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  treatment <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="at">size =</span> numDoctors <span class="sc">*</span> numPatients, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Random effects for doctors</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  doctorIntercept <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(numDoctors, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Variation in doctor baseline recovery times</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  doctorTreatmentBEffect <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(numDoctors, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Variation in treatment B effect by doctor</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  doctorTreatmentCEffect <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(numDoctors, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Variation in treatment C effect by doctor</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate recovery time</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  doctor_var<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.4</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="fl">0.9</span>,<span class="fl">1.3</span>,<span class="dv">20</span>))</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  tr<span class="ot">&lt;-</span>treatmentEffect[treatment]</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(doctors))</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"A"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"A"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">1</span>]</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"B"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"B"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">2</span>]</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"C"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"C"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">3</span>]</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  recoveryTime <span class="ot">&lt;-</span> intercept<span class="sc">+</span>tr <span class="sc">+</span> </span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>                  <span class="co">#(treatment == "B") * doctorTreatmentBEffect[doctors] + </span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>                  <span class="co">#(treatment == "C") * doctorTreatmentCEffect[doctors] + </span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>                  doctorIntercept[doctors] <span class="sc">+</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rnorm</span>(numDoctors <span class="sc">*</span> numPatients, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Add some observation noise</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">doctor =</span> doctors, <span class="at">treatment =</span> treatment, <span class="at">recoveryTime =</span> recoveryTime)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>data_int_treatment <span class="ot">&lt;-</span> <span class="fu">simulatePatientData_treatment_doctor</span>(<span class="at">numDoctors =</span> <span class="dv">3</span>,<span class="at">numPatients =</span> <span class="dv">200</span>)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>data_int_treatment<span class="sc">$</span>treatment <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_int_treatment<span class="sc">$</span>treatment)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int_treatment<span class="sc">$</span>recoveryTime <span class="sc">~</span> <span class="fu">jitter</span>(<span class="fu">as.numeric</span>(data_int_treatment<span class="sc">$</span>treatment), <span class="dv">1</span>), <span class="at">col=</span><span class="fu">as.factor</span>(data_int_treatment<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_treatment<span class="sc">$</span>doctor)),<span class="at">xaxt=</span><span class="st">"n"</span>,<span class="at">xlab=</span><span class="st">"Treatment"</span>,<span class="at">ylab =</span> <span class="st">"Recovery Time"</span>)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"C"</span>))</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Doctor"</span>, <span class="fu">unique</span>(data_int_treatment<span class="sc">$</span>doctor)),</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_treatment<span class="sc">$</span>doctor), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Doctor"</span>,<span class="at">horiz=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Scatter plot of treatment vs recovery time
</figcaption>
</figure>
</div>
</div>
</div>
<p>In this example, we have three treatments each given by three different doctors. What we are interested in is the treatment effect. However, what we believe is that patients going to different doctors might experience slightly different outcomes not just because of the treatment itself but also due to the specific practices or approaches of each doctor. Therefore, to accurately assess the treatment effect, we need to account for the variability introduced by the doctors. We decide to use random intercept model <code>lmer(recoveryTime~treatment+(1|doctor),data_int_treatment)</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>doctor),data_int_treatment)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment + (1 | doctor)
   Data: data_int_treatment
REML criterion at convergence: 3586.159
Random effects:
 Groups   Name        Std.Dev.
 doctor   (Intercept) 2.298   
 Residual             4.782   
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
(Intercept)   treatmentB   treatmentC  
      50.75       -49.81       -14.33  </code></pre>
</div>
</div>
<p>In the linear mixed model we’ve fitted, it’s essential to note that due to the categorical nature of the treatment variable, there is no “slope” for the treatment variable in the conventional sense. Instead, the model estimates the differences in the intercept (mean recovery time) for treatments B and C relative to treatment A which is the same as the slope of the regression line in this case. Therefore, In the model, treatment effects are represented as shifts from the baseline (treatment A) rather than as distinct slopes or lines. If we look at the estimated fixed effects, we see that we have an intercept and two more coefficients for treatment B and treatment C. The intercept represents the expected recovery time for treatment A, and the coefficients for treatmentB and treatmentC represent the deviation in recovery time from treatment A.</p>
<p>Let’s plot these effects first before interpreting the random effects:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int_treatment<span class="sc">$</span>recoveryTime <span class="sc">~</span> <span class="fu">jitter</span>(<span class="fu">as.numeric</span>(data_int_treatment<span class="sc">$</span>treatment), <span class="dv">1</span>), <span class="at">col=</span><span class="fu">as.factor</span>(data_int_treatment<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_treatment<span class="sc">$</span>doctor)),<span class="at">xaxt=</span><span class="st">"n"</span>,<span class="at">xlab=</span><span class="st">"Treatment"</span>,<span class="at">ylab =</span> <span class="st">"Recovery Time"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"C"</span>))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Doctor"</span>, <span class="fu">unique</span>(data_int_treatment<span class="sc">$</span>doctor)),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_treatment<span class="sc">$</span>doctor), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Doctor"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">fixef</span>(model_lmm_treatment)[<span class="dv">1</span>],<span class="at">b =</span> <span class="dv">0</span>,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">fixef</span>(model_lmm_treatment)[<span class="dv">1</span>]<span class="sc">+</span><span class="fu">fixef</span>(model_lmm_treatment)[<span class="dv">2</span>],<span class="at">b =</span> <span class="dv">0</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">fixef</span>(model_lmm_treatment)[<span class="dv">1</span>]<span class="sc">+</span><span class="fu">fixef</span>(model_lmm_treatment)[<span class="dv">3</span>],<span class="at">b =</span> <span class="dv">0</span>,<span class="at">col=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-fixed-effect" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-fixed-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-fixed-effect-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-fixed-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Scatter plot of treatment vs recovery time (fixed effects)
</figcaption>
</figure>
</div>
</div>
</div>
<p>Given such a fit, what do you think the random intercept model actually does?</p>
<p>The answer to this question is actually quite simple. What we asked <code>lmer</code> to do, was to assume that the <code>Intercept</code> is the random effect. In this particular example the intercept is the baseline level of the treatment A. Therefore, the random intercept captures variability at the doctor level around the baseline effect of treatment A:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">coef</span>(model_lmm_treatment))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$doctor
  (Intercept) treatmentB treatmentC
1    48.12258  -49.81091  -14.33386
2    52.07763  -49.81091  -14.33386
3    52.04323  -49.81091  -14.33386

attr(,"class")
[1] "coef.mer"</code></pre>
</div>
</div>
<p>Despite that we saw that there is three lines (three intercepts) in this model, only the first one is assume to be random. The coefficients for treatments B and C are relative to this random baseline and have not been allowed to change depending on the doctor. This model is sufficient if we assume that the effect of the treatments is consistent across all doctors, meaning that the difference in recovery times between treatments does not vary from one doctor to another. Essentially, it assumes that each treatment’s effectiveness is uniform regardless of who administers it.</p>
<p>Let’s plot these effects before proceeding:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>doctor_effects <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">doctor=</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),<span class="fu">coef</span>(model_lmm_treatment)<span class="sc">$</span>doctor)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(doctor_effects)[<span class="dv">2</span>]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"intercept"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate adjusted means for treatments B and C</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>doctor_effects<span class="sc">$</span>treatmentB_effect <span class="ot">=</span> doctor_effects<span class="sc">$</span>intercept <span class="sc">+</span> doctor_effects<span class="sc">$</span>treatmentB</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>doctor_effects<span class="sc">$</span>treatmentC_effect <span class="ot">=</span> doctor_effects<span class="sc">$</span>intercept <span class="sc">+</span> doctor_effects<span class="sc">$</span>treatmentC</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NULL</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(doctor_effects<span class="sc">$</span>intercept, doctor_effects<span class="sc">$</span>treatmentB_effect, doctor_effects<span class="sc">$</span>treatmentC_effect)), <span class="at">xlab=</span><span class="st">"Doctor"</span>, <span class="at">ylab=</span><span class="st">"Recovery Time"</span>, <span class="at">main=</span><span class="st">"Effect of Doctor and Treatment on Recovery Time"</span>,<span class="at">xaxt=</span><span class="st">"n"</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"1"</span>,<span class="st">"2"</span>,<span class="st">"3"</span>))</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>intercept, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"blue"</span>) <span class="co"># Baseline (A)</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentB_effect, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"red"</span>) <span class="co"># Treatment B</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentC_effect, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"green"</span>) <span class="co"># Treatment C</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect points with lines to show the constant effect across doctors</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>intercept, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentB_effect, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentC_effect, <span class="at">col=</span><span class="st">"green"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"right"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Baseline (A)"</span>, <span class="st">"Treatment B"</span>, <span class="st">"Treatment C"</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"green"</span>), <span class="at">pch=</span><span class="dv">19</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-random-effect" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-random-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-random-effect-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-random-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Scatter plot of treatment vs recovery time (random intercept)
</figcaption>
</figure>
</div>
</div>
</div>
<p>What this plot tells us is that, each doctor might have certain way of treating patient which affect the overall recovery time. However, what we assume is that the treatment specific effects are constant across the doctors. That means that no matter which doctor a patient go to, there is a <strong>constant</strong> shift in recovery time when the patient switch between the treatments. But what if some doctors are much more skilled that others to administrate a certain type of treatments? The previous model does not allow for the examination of how the effect of <strong>each treatment</strong> might vary by doctor, as it assumes a fixed effect of treatments across all doctors.</p>
<p>We have to specifically clarify for <code>lmer</code> which effects we want to be random. In this case, we are going to use the treatment effect as random and check what would happen</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_rnd <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">|</span>doctor),data_int_treatment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
Model failed to converge with max|grad| = 0.00275838 (tol = 0.002, component 1)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment + (1 + treatment | doctor)
   Data: data_int_treatment
REML criterion at convergence: 2545.443
Random effects:
 Groups   Name        Std.Dev. Corr       
 doctor   (Intercept)  3.4988             
          treatmentB   0.4936  -0.84      
          treatmentC  11.2470  -0.80  0.34
 Residual              1.9710             
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
(Intercept)   treatmentB   treatmentC  
      50.89       -50.02       -14.27  
optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings </code></pre>
</div>
</div>
<p>If we look at the random effect part of the model, it is now more clear that There is not only a big difference between the doctors when it comes to treatment A but also an even larger difference in treatment C.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>doctor_effects <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">doctor=</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),<span class="fu">coef</span>(model_lmm_treatment_rnd)<span class="sc">$</span>doctor)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(doctor_effects)[<span class="dv">2</span>]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"intercept"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate adjusted means for treatments B and C</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>doctor_effects<span class="sc">$</span>treatmentB_effect <span class="ot">=</span> doctor_effects<span class="sc">$</span>intercept <span class="sc">+</span> doctor_effects<span class="sc">$</span>treatmentB</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>doctor_effects<span class="sc">$</span>treatmentC_effect <span class="ot">=</span> doctor_effects<span class="sc">$</span>intercept <span class="sc">+</span> doctor_effects<span class="sc">$</span>treatmentC</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NULL</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(doctor_effects<span class="sc">$</span>intercept, doctor_effects<span class="sc">$</span>treatmentB_effect, doctor_effects<span class="sc">$</span>treatmentC_effect)), <span class="at">xlab=</span><span class="st">"Doctor"</span>, <span class="at">ylab=</span><span class="st">"Recovery Time"</span>, <span class="at">main=</span><span class="st">"Effect of Doctor and Treatment on Recovery Time"</span>,<span class="at">xaxt=</span><span class="st">"n"</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"1"</span>,<span class="st">"2"</span>,<span class="st">"3"</span>))</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>intercept, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"blue"</span>) <span class="co"># Baseline (A)</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentB_effect, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"red"</span>) <span class="co"># Treatment B</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentC_effect, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"green"</span>) <span class="co"># Treatment C</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect points with lines to show the constant effect across doctors</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>intercept, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentB_effect, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(doctor_effects<span class="sc">$</span>doctor, doctor_effects<span class="sc">$</span>treatmentC_effect, <span class="at">col=</span><span class="st">"green"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"right"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Baseline (A)"</span>, <span class="st">"Treatment B"</span>, <span class="st">"Treatment C"</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"green"</span>), <span class="at">pch=</span><span class="dv">19</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-random-effect2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-random-effect2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-random-effect2-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-random-effect2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Scatter plot of treatment vs recovery time (random intercept and deviation)
</figcaption>
</figure>
</div>
</div>
</div>
<p>So despite that there is no slope for continuous variable in a traditional sense, we can still model the variations in the deviations from the baseline. This model structure is particularly useful for highlighting the overall effectiveness of each treatment while controlling for variability in outcomes attributed to individual doctor differences.</p>
<p>We can now explore a bit more complex model that involves the interaction.</p>
<section id="models-with-interaction" class="level4">
<h4 class="anchored" data-anchor-id="models-with-interaction">Models with interaction</h4>
<p>In this example, our aim is to explore how the effectiveness of various treatments may vary with changes in dosage, and whether these effects are consistent across different doctors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>simulatePatientData <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">numDoctors =</span> <span class="dv">30</span>, <span class="at">numPatients =</span> <span class="dv">10</span>,doctor_dosage,doctor_var, <span class="at">seed =</span> <span class="dv">12345</span>) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">=</span> <span class="dv">50</span>  <span class="co"># Baseline recovery time</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  treatmentEffect <span class="ot">=</span> <span class="fu">c</span>(<span class="at">A =</span> <span class="dv">0</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">C =</span> <span class="sc">-</span><span class="dv">20</span>)  <span class="co"># Treatment effect on recovery time</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  dosageEffect <span class="ot">=</span> <span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="dv">1</span>) <span class="co"># Effect of dosage on recovery time</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate data</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  doctors <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>numDoctors, <span class="at">each =</span> numPatients)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  treatment <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="at">size =</span> numDoctors <span class="sc">*</span> numPatients, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  dosage <span class="ot">&lt;-</span> <span class="fu">runif</span>(numDoctors <span class="sc">*</span> numPatients, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>)  <span class="co"># Dosage levels between 1 and 10</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  dosageEffect<span class="ot">&lt;-</span><span class="fu">rep</span>(dosageEffect,<span class="at">each=</span>numPatients)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Random effects for doctors</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  doctorIntercept <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(numDoctors, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Variation in doctor baseline recovery times</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate recovery time</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  tr<span class="ot">&lt;-</span>treatmentEffect[treatment]</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(doctors))</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"A"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"A"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">1</span>]</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"B"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"B"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">2</span>]</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"C"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"C"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">3</span>]</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  recoveryTime <span class="ot">&lt;-</span> intercept<span class="sc">+</span>tr <span class="sc">+</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">unlist</span>(doctor_dosage)[<span class="fu">paste</span>(doctors,<span class="st">"."</span>,treatment,<span class="at">sep=</span><span class="st">""</span>)] <span class="sc">*</span> dosage <span class="sc">+</span> doctorIntercept[doctors] <span class="sc">+</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rnorm</span>(numDoctors <span class="sc">*</span> numPatients, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Add some observation noise</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">doctor =</span> doctors, <span class="at">treatment =</span> treatment, <span class="at">dosage =</span> dosage, <span class="at">recoveryTime =</span> recoveryTime)</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the data</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>data_int_interaction <span class="ot">&lt;-</span> <span class="fu">simulatePatientData</span>(<span class="at">numDoctors =</span> <span class="dv">3</span>,<span class="at">numPatients =</span> <span class="dv">200</span>,<span class="at">doctor_dosage=</span><span class="fu">list</span>(<span class="st">"1"</span><span class="ot">=</span><span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="dv">1</span>),</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"2"</span><span class="ot">=</span><span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="dv">1</span>),<span class="st">"3"</span><span class="ot">=</span><span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="sc">-</span><span class="dv">1</span>)),<span class="at">doctor_var=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.4</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="fl">0.9</span>,<span class="dv">1</span>,<span class="dv">50</span>)))</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>data_int_interaction<span class="sc">$</span>treatment<span class="ot">&lt;-</span><span class="fu">factor</span>(data_int_interaction<span class="sc">$</span>treatment,<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"C"</span>))</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a> <span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Doctor"</span>, <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Doctor"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Treatment"</span>, <span class="fu">levels</span>(data_int_interaction<span class="sc">$</span>treatment)),</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch=</span><span class="dv">1</span>,<span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">levels</span>(data_int_interaction<span class="sc">$</span>treatment)), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Treatment"</span>,<span class="at">horiz=</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Scatter plot of treatment vs recovery time vs dosage
</figcaption>
</figure>
</div>
</div>
</div>
<p>What we believe is that there is dose-response relationship that is not uniform across all treatments. In other words, the impact of increasing dosage on treatment effectiveness might depend on the specific type of treatment being administered. To investigate this hypothesis, we incorporate interaction terms into our mixed model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_dosse <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>doctor),data_int_interaction)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_dosse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 | doctor)
   Data: data_int_interaction
REML criterion at convergence: 4366.567
Random effects:
 Groups   Name        Std.Dev.
 doctor   (Intercept) 9.874   
 Residual             9.170   
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.905            -51.009             -7.324              2.950  
treatmentB:dosage  treatmentC:dosage  
           -4.708             -2.210  </code></pre>
</div>
</div>
<p>Similar to the previous case, we start assuming a random intercept in the model. What we see is that there is a big variation across different doctors when it comes to the baseline of the treatment A. However, here we only assumed that there is only the level of treatment A is random across the doctors. Let’s look at the fitted lines:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>What is clear is that the fit does not look that promising specially when it comes to the Doctor 3 (treatment C). One might suspect that the effect of dosage administration can also depend on the doctor. In this case, we need to model the dosage as random effect:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_doss_rnd <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>dosage<span class="sc">|</span>doctor),data_int_interaction)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_doss_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 + dosage | doctor)
   Data: data_int_interaction
REML criterion at convergence: 4363.593
Random effects:
 Groups   Name        Std.Dev. Corr 
 doctor   (Intercept) 11.5752       
          dosage       0.3271  -0.96
 Residual              9.1444       
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.807            -50.937             -7.268              2.975  
treatmentB:dosage  treatmentC:dosage  
           -4.737             -2.218  </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>Looking at the plot above and the output of the mixed model, the fit does not look much better than before. <code>Dosage</code> alone also does not seem to explain much of the variability. So what are we missing?</p>
<p>Similar to the previous scenario, not only the baseline treatment level (treatment A) is changing across the doctors but also the rate at which the doctors perform the treatment change. So let’s incorporate this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_doss_trt_rnd <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">+</span>dosage<span class="sc">|</span>doctor),data_int_interaction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>boundary (singular) fit: see help('isSingular')</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_doss_trt_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 + treatment + dosage |  
    doctor)
   Data: data_int_interaction
REML criterion at convergence: 2791.263
Random effects:
 Groups   Name        Std.Dev. Corr             
 doctor   (Intercept)  4.8070                   
          treatmentB   0.3789  -1.00            
          treatmentC  22.4419   0.85 -0.85      
          dosage       0.3988  -0.84  0.84 -1.00
 Residual              2.4015                   
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.462            -49.589             -4.396              3.096  
treatmentB:dosage  treatmentC:dosage  
           -5.068             -2.727  
optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now the fit looks much better than before. We can see in the output that the treatment C is now explaining a lot of variablity across different doctors. At this point the main question is given that we have assumed the differences in the treatment levels can be changing across the doctors could it be that the differences between the slopes are also random?</p>
<p>What this means is that so far, what we have done is modeling <code>(Intercept)</code>, <code>treatmentB</code>, <code>treatmentC</code>, <code>dosage</code> as random effects. But <code>treatmentB:dosage</code> and <code>treatmentC:dosage</code> are still fixed. This translate to a scenario that we believe there is a general differences between the doctors in a way that they administrate a <em>specific</em> treatment and also how they generally work with doses. But what if a doctor is much more skilled in administrating a dosage for a specific treatment?</p>
<p>In this case, we have to model the interaction as random effect:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_int_rnd <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>boundary (singular) fit: see help('isSingular')</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_int_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 + treatment * dosage |  
    doctor)
   Data: data_int_interaction
REML criterion at convergence: 2580.411
Random effects:
 Groups   Name              Std.Dev. Corr                         
 doctor   (Intercept)        2.4125                               
          treatmentB         0.9628   1.00                        
          treatmentC        29.8136   0.43  0.43                  
          dosage             0.1635   0.86  0.86  0.84            
          treatmentB:dosage  0.2239  -1.00 -1.00 -0.47 -0.88      
          treatmentC:dosage  1.3260  -0.46 -0.46 -1.00 -0.85  0.50
 Residual                    2.0081                               
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.644            -49.623             -4.641              3.050  
treatmentB:dosage  treatmentC:dosage  
           -5.027             -2.642  
optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="lmm_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>This final model tells that that the three main sources of variation in our data is <code>treatmentC</code>, <code>(Intercept)</code> and <code>treatmentC:dosage</code>. The fit also looks much better than before. This result translates to a scenario in which there is a variability between doctors in how they treat patients, there is a significant variability between then in the way they administrate the treatment C and also how they administrate dosage for treatment C.</p>
<p>To summarize this section, I want to point out that despite that there are some general terms such as random intercept or random slope models, one might often end up specifically model certain effects as random or fixed depending on the experimental design and characteristic of the samples and population. These effect should have been ideally studied prior to setting up the statistical model to avoid bias. In the next section we will have a look at some automated way of selecting fixed and random effect.</p>
</section>
</section>
</section>
<section id="model-selection-and-comparisons-using-lrt" class="level2">
<h2 class="anchored" data-anchor-id="model-selection-and-comparisons-using-lrt">Model selection and comparisons using LRT</h2>
<p>A critical step in using mixed models models effectively is determining which model provides the best fit to the data without overcomplicating the structure. ANOVA for mixed models serves as a tool for hypothesis testing between models, specifically testing if a more complex model significantly improves the explanation of data variability over a simpler one. Without going too much into the details (theory is covereted in the math section), what we are going to do is likelyhood ratio test (LRT) between different models. The Likelihood Ratio Test (LRT) is a statistical procedure used to compare the fit of two models to a set of data, where one model (the null model) is a special case of the other model (the alternative model). The LRT evaluates whether the more complex model significantly improves the fit to the data over the simpler model. The LRT is based on the likelihood ratio, which is a measure of how much more likely the data is under one model compared to another. Specifically, it compares the maximum likelihood of the data under the null hypothesis ((H_0), a simpler model with constraints on parameters) against the maximum likelihood under the alternative hypothesis ((H_1), a more complex model without those constraints).</p>
<p>In the case of mixed models, as you noticed, we have two sets of parameters to consider: fixed effects, which are common to all observations, and random effects, which vary across levels of a grouping factor (e.g., subjects, experiments, clusters). This dual nature adds a layer of complexity to model selection and comparison. Specifically, when conducting an LRT, we’re not only interested in how adding or removing fixed effects influences the model but also in how variations in the random effects structure contribute to explaining the data variability.</p>
<p>There are different approaches on how to apply model selection on mixed models. Here we are going to use a simple approach.</p>
<p>First we are going to use LRT to select the random part of the model. With random part of the model chosen, we will proceed with selecting the fixed part. <code>lme4</code> package provides <code>anova</code> function for doing so. As suggested by some authors, we are going to fit the models as complex as we belive they are and see whether a simpler model is prefered.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When we apply model selection for the random part, all the models must have the same fixed structure. Similar, when working with fixed part, the random stucture of the model must remain the same.</p>
</div>
</div>
<p>So let’s start with the random part of the model that included the interaction.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">+</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(m1,m2,m3,m4,<span class="at">refit=</span><span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data_int_interaction
Models:
m1: recoveryTime ~ treatment * dosage + (1 | doctor)
m2: recoveryTime ~ treatment * dosage + (1 + treatment | doctor)
m3: recoveryTime ~ treatment * dosage + (1 + treatment + dosage | doctor)
m4: recoveryTime ~ treatment * dosage + (1 + treatment * dosage | doctor)
   npar    AIC    BIC  logLik deviance   Chisq Df Pr(&gt;Chisq)    
m1    8 4382.6 4417.7 -2183.3   4366.6                          
m2   13 2887.0 2944.2 -1430.5   2861.0 1505.55  5  &lt; 2.2e-16 ***
m3   17 2825.3 2900.0 -1395.6   2791.3   69.75  4  2.563e-14 ***
m4   28 2636.4 2759.5 -1290.2   2580.4  210.85 11  &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The ANOVA table provides essential metrics for model comparison.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ANOVA table columns
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><strong>Number of Parameters (npar):</strong></p>
<p>The ‘npar’ indicates the total number of parameters estimated by the model, reflecting its complexity.</p>
<p><strong>Akaike Information Criterion (AIC):</strong></p>
<p>AIC assesses the model quality, penalizing excessive complexity. Models with lower AIC values are generally preferred, as they give a balance between fitting the data well and being parsimonious.</p>
<p><strong>Bayesian Information Criterion (BIC):</strong></p>
<p>Similar to AIC, the BIC also rewards model fit but imposes a stricter penalty on the number of parameters. BIC is particularly useful for model selection in scenarios where overfitting is a concern, as its heavier penalty discourages unnecessarily complex models.</p>
<p><strong>Log-Likelihood (logLik):</strong></p>
<p>Log-likelihood is a direct measure of model fit, representing the logarithm of the likelihood function at its maximum point. Higher values indicate better fit.</p>
<p><strong>Deviance:</strong></p>
<p>Derived from the log-likelihood, deviance is a measure of model fit that allows direct comparison between models. It is defined as twice the difference between the maximum log-likelihood and the log-likelihood under the model being tested. Lower deviance values indicate a better fit to the data.</p>
<p><strong>Chi-Squared Test (Chisq) and Degrees of Freedom (Df):</strong></p>
<p>These metrics are used to test whether the addition of parameters (and thus, complexity) significantly improves the model fit. The chi-squared statistic tests the null hypothesis that both models fit the data equally well. The degrees of freedom, calculated as the difference in parameters between models, help determine the critical value for this test.</p>
<p><strong>Probability Value (Pr(&gt;Chisq)):</strong></p>
<p>A low p-value (typically &lt;0.05) indicates that the more complex model provides a significantly better fit to the data, justifying its additional complexity.</p>
</div>
</div>
</div>
<p>The table is sorted based on the complexity of the model (the number of parameters). The first row is the least and the last row is the most complex model. The columns used for comparisons the <code>Pr(&gt;Chisq)</code> (p-value) is comparions the current row to the previous one. So let’s start interpreting the results from the table, it’s evident that each successive, more complex model significantly improves the fit to the data over its predecessor, as indicated by the <code>Pr(&gt;Chisq)</code> column. This p-value compares the current model to the previous one in terms of how much more likely the data is under the more complex model.</p>
<p>Starting with model m1, which includes a random intercept for doctors, we observe a baseline for comparison. This model sets the foundation with a certain number of parameters (npar = 8), Akaike Information Criterion (AIC), Bayesian Information Criterion (BIC), log-likelihood (logLik), and deviance scores.</p>
<p>When we move to model m2, which adds treatment as a random slope alongside the doctor, we see a substantial improvement in model fit. This is evidenced by the dramatic reduction in AIC and BIC values and a significant chi-squared statistic (Chisq = 1505.55) with a p-value less than 2.2e-16, indicating a highly significant improvement over m1. The addition of treatment as a random effect accounts for the variability in treatment effects across doctors, enhancing the model’s explanatory power.</p>
<p>The transition from m2 to m3, where dosage is added as another random slope, continues to show significant model improvement, albeit the magnitude of improvement is less dramatic than the previous step. This is reflected in the Chisq value of 69.75 with a p-value of 2.563e-14, indicating that incorporating dosage variability across doctors further refines our model’s accuracy.</p>
<p>Finally, model m4, which introduces an interaction between treatment and dosage as a random slope, marks the most substantial complexity increase, as shown by the jump in the number of parameters to 28. This model shows another significant leap in fit, with a Chisq value of 210.85 and a p-value less than 2.2e-16. The substantial decrease in AIC and BIC values alongside this indicates that considering the interaction between treatment and dosage in the model’s random effects structure captures a critical aspect of the data’s underlying structure, providing the best fit among the compared models.</p>
<p>In summary, the progression from m1 to m4 illustrates a clear trajectory of increasing model complexity leading to significantly improved fits to the data, as demonstrated by decreasing AIC/BIC values and highly significant p-values in the likelihood ratio tests.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that in order to compare the random effect part, we HAVE to set <code>refit=FALSE</code> in the anova function. The reason for this is that using <code>refit=FALSE</code> would use the original estimation method, which in our case was Restricted Maximum Likelihood (REML). REML adjusts for the loss of degrees of freedom when estimating fixed effects, providing unbiased estimates of variance components. We must always use <code>REML = TRUE</code> when fitting and reporting mixed models. However, REML assumes that the fixed effects structure is correct. So in order to compare fixed effect part of the model, we need to use <code>refit=TRUE</code> or fit the original mixed model using <code>REML = FALSE</code> only for the purpose of comparing the fixed effects. The repoted/final model must always be based on <code>REML = TRUE</code>. More about this in the math section.</p>
</div>
</div>
<p>Give we now know that our interaction model was the best one, we can now proceed with refining our model by selecting the most appropriate fixed effects. We will keep the random part constant across the models and change the fixed part:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span><span class="dv">1</span><span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">+</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(m1,m2,m3,m4,<span class="at">refit=</span><span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data_int_interaction
Models:
m1: recoveryTime ~ 1 + (1 + treatment * dosage | doctor)
m2: recoveryTime ~ treatment + (1 + treatment * dosage | doctor)
m3: recoveryTime ~ treatment + dosage + (1 + treatment * dosage | doctor)
m4: recoveryTime ~ treatment * dosage + (1 + treatment * dosage | doctor)
   npar    AIC    BIC  logLik deviance   Chisq Df Pr(&gt;Chisq)    
m1   23 2657.9 2759.0 -1305.9   2611.9                          
m2   25 2646.2 2756.2 -1298.1   2596.2 15.6092  2  0.0004078 ***
m3   26 2647.7 2762.0 -1297.8   2595.7  0.5915  1  0.4418240    
m4   28 2632.4 2755.5 -1288.2   2576.4 19.2892  2  6.477e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Starting with model m1, which serves as our baseline model including only the intercept in the fixed part, we assess the improvement in fit as we incrementally add fixed effects. Model m1 establishes the groundwork with specific values for the number of parameters (npar), AIC, BIC, log-likelihood (logLik), and deviance.</p>
<p>The progression to model m2, which introduces treatment as a fixed effect, gives a big improvement in the model’s explanatory power. This is clear by a decrease in both AIC and BIC scores and a significant chi-squared statistic (Chisq = 15.6092) with a p-value of 0.0004078. The statistical significance indicates that the inclusion of treatment as a fixed effect significantly enhances the model’s fit over the baseline model, which is consistent with the expectation that treatment would have a systematic effect on recovery time.</p>
<p>Going to model m3, which further includes dosage alongside treatment in the fixed effects, we observe a marginal change. The chi-squared statistic (Chisq = 0.5915) with a p-value of 0.4418240 suggests that the addition of dosage as a fixed effect does not significantly improve the model’s fit beyond what is achieved by including treatment alone.</p>
<p>Model m4 reintroduces the treatment by dosage interaction in the fixed effects, reflecting the most complex fixed-effects structure among the evaluated models. The significant reduction in AIC and BIC values, coupled with a chi-squared statistic (Chisq = 19.2892) and a p-value of 6.477e-05, shows the critical importance of this interaction term. The substantial improvement in model fit indicates that the interaction between treatment and dosage is a key factor in explaining variations in recovery time, warranting its inclusion in both the fixed and random components of the model.</p>
<p>We now know that our final model should be in the form of <code>lmer(recoveryTime~treatment*dosage+(1+treatment*dosage|doctor),data_int_interaction, REML = TRUE)</code>. Please note that we use <code>REML=TRUE</code> in the final model.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is always a good practice to design the model based on the population/sample structure and experimental design. Despite model selection being a powerful tool, it cannot replace the necessity for substantive knowledge and theoretical understanding of the phenomena under study. Relying solely on automated procedures or statistical criteria (like AIC or BIC) for model selection can lead to overfitting, misinterpretation of model parameters, and conclusions that do not accurately reflect the underlying processes. Moreover, important variables might be overlooked if they are not considered in the model selection process. Hence, it’s crucial to integrate domain expertise with statistical approaches, ensuring that the chosen model is both statistically sound and theoretically justified.</p>
</div>
</div>
</section>
<section id="model-daignostic" class="level2">
<h2 class="anchored" data-anchor-id="model-daignostic">Model daignostic</h2>
<p>The assumptions of mixed models are very similar to those of linear models. By far the most informative way of checking the model assumptions is the residuals vs fitted plot. This can be easily plotted using the <code>plot</code> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_lmm_treatment_int_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="lmm_files/figure-html/residul_vs_fitted-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Scatter plot of residuals vs fitted values</figcaption>
</figure>
</div>
</div>
</div>
<p>A residuals versus fitted values plot provides insights into several assumptions underlying linear and mixed models. When interpreting this plot, there are a few key scenarios and patterns to look out for, each indicating different potential violations of model assumptions or areas for model improvement:</p>
<ol type="1">
<li><strong>Homoscedasticity vs.&nbsp;Heteroscedasticity</strong></li>
</ol>
<ul>
<li><strong>Homoscedasticity</strong> is assumed in linear models, meaning the variance of the residuals should be constant across all levels of the fitted values. In the plot, this would appear as a random scatter of points, evenly spread across the range of fitted values.</li>
<li><strong>Heteroscedasticity</strong> manifests as a fan-shaped or funnel-shaped pattern, where the spread of residuals increases or decreases as a function of the fitted values. This indicates that the variance of the errors is not constant and may necessitate transformations of variables or the use of models that allow for non-constant variance, such as generalized least squares.</li>
</ul>
<ol start="2" type="1">
<li><strong>Linearity</strong></li>
</ol>
<ul>
<li>The relationship between predictors and the response variable in linear models is assumed to be linear. A properly specified model should show no systematic patterns in the residuals plot. If the residuals appear to follow a curved pattern, this suggests a nonlinear relationship that the model has not captured, indicating the need for model revision, such as adding polynomial terms or considering non-linear models.</li>
</ul>
<ol start="3" type="1">
<li><strong>Independence of Errors</strong></li>
</ol>
<ul>
<li>Residuals should be independent of each other. In the context of time series data or spatial data, this assumption might be violated, often visible as “clumps” or “streaks” of residuals in the plot, indicating autocorrelation. Special models like ARIMA for time series or spatial models might be needed in these cases.</li>
</ul>
<ol start="4" type="1">
<li><strong>Outliers</strong></li>
</ol>
<ul>
<li>Outliers can be identified as points that stand far away from the cloud of points in the residuals vs.&nbsp;fitted plot. These outliers can have a disproportionate influence on the model fit and may need to be investigated further to determine if they should be removed or treated differently.</li>
</ul>
<ol start="5" type="1">
<li><strong>Missing Nonlinear Effects or Interactions</strong></li>
</ol>
<ul>
<li>If the residuals plot shows patterns, this might suggest that important predictors or interactions between predictors are missing from the model. Investigating the nature of these patterns can guide the inclusion of additional terms in the model.</li>
</ul>
<p>There are other types of diagnostics tools and plots that can be used in different scenarios. <code>performance</code> package provides an easy to use function to check the assumptions of linear models. You need to install <code>performance</code> package to run the following code:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">check_model</span>(model_lmm_treatment_int_rnd, <span class="at">panel =</span> T,<span class="at">check =</span> <span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="lmm_files/figure-html/performance_check_model-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Example of plots made using performance package</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="p-value-calculation-and-marginal-means" class="level2">
<h2 class="anchored" data-anchor-id="p-value-calculation-and-marginal-means">P-value calculation and marginal means</h2>
<p>Without going too much into the details, obtaining accurate p-values in mixed models requires sophisticated statistical techniques. The issue is in determining the correct denominator degrees of freedom for significance tests in mixed models. Unlike simpler models where the denominator degrees of freedom can be straightforwardly calculated, mixed models introduce ambiguity due to their structure and data hierarchies. With more complex, crossed, or unbalanced designs, the choice of denominator degrees of freedom becomes less clear. Should it be based on the number of observations, the number of subjects or items, the number of random effects, or some combination thereof? This uncertainty complicates the calculation of p-values, on top of that in (many) hierarchical models the cumulative distribution function of the test statistic when the null hypothesis is true is simply not known. Consequently, <code>lme4</code> package does not directly give us a p-value.</p>
<p>There are some approximations methods that can be used to find the degrees of freedom such as Satterthwaite and Kenward-Roger and use F-distribution to calculate p-values. We are going to use those here using the package <code>emmeans</code>. This package gives us estimated marginal means (EMMs) for different types of models including mixed models.</p>
<p>Before proceeding with the actual analysis i want to briefly tell you about marginal means. Marginal means are designed to calculate the average expected outcome on a dependent variable—take recovery time as an example—across varying levels of a factor, such as different treatment types, while accounting for the influence of other variables in the model. This adjustment is there to ensure that the marginal means reflect the isolated effect of each factor, free from confounding variables.</p>
<p>One of the most important aspects of EMMs is their ability to provide clear, comparable insights even in the face of unbalanced data. Unlike simpler analytical methods that may be biased when data lack symmetry across groups or conditions, EMMs adjust for these differences, offering an accurate representation of group effects. There are great guidelines on how to use <code>emmeans</code> <a href="https://cran.r-project.org/web/packages/emmeans/">here</a> so please read them if you want to get more complex analysis done.</p>
<p>In our case however, we are interested in two comparisons. First we are going to compare the treatments and then the dosage effect.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>em_object <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model_lmm_treatment_int_rnd,<span class="at">specs =</span> <span class="st">"treatment"</span>,<span class="at">by =</span> <span class="st">"dosage"</span>,<span class="at">lmer.df =</span> <span class="st">"satterthwaite"</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">pairs</span>(em_object))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>dosage = 5.5:
 contrast estimate     SE   df t.ratio p.value
 A - B        77.3  0.259 3.27 298.479  &lt;.0001
 A - C        19.2 13.003 2.15   1.475  0.4477
 B - C       -58.1 13.097 2.15  -4.437  0.0758

Degrees-of-freedom method: satterthwaite 
P value adjustment: tukey method for comparing a family of 3 estimates </code></pre>
</div>
</div>
<p>In the code above the <code>emmeans</code> function is called with the fitted mixed model object (<code>model_lmm_treatment_int_rnd</code>) to estimate marginal means for the <code>treatment</code> factor. The <code>specs</code> argument specifies that we are focusing on the treatment effect. The <code>by = "dosage"</code> argument indicates that these comparisons will be made within levels or average of the dosage variable, allowing for an examination of how treatment effects change with different dosages. The <code>lmer.df = "satterthwaite"</code> argument specifies that the Satterthwaite approximation should be used to estimate the degrees of freedom for the tests, which is crucial for mixed models where the degrees of freedom are not straightforward.</p>
<p>The <code>pairs</code> function is used to compare every pair of treatment levels within average dosage level. This results in a table showing the contrast (difference) between each pair of treatments, the estimate of this difference, its standard error (SE), degrees of freedom (df), t-ratio, and the p-value for the significance of the difference.</p>
<p>For a dosage of 5.5, the results of the pairwise comparisons between treatments are as follows:</p>
<ul>
<li><p><strong>A vs.&nbsp;B</strong>: The estimated difference in the response variable between treatments A and B is 77.3 units, with a very small standard error (SE = 0.259), leading to a highly significant p-value (&lt;.0001). This suggests a strong evidence of a significant difference between treatments A and B at this dosage level.</p></li>
<li><p><strong>A vs.&nbsp;C</strong>: The difference between treatments A and C is 19.2 units, but with a much larger standard error (SE = 13.003) and a p-value of 0.4477. This indicates that the difference between treatments A and C at this dosage level is not statistically significant.</p></li>
<li><p><strong>B vs.&nbsp;C</strong>: The difference here is -58.1 units, with a standard error of 13.097. The p-value is 0.0758, which suggests that while there is a noticeable difference between treatments B and C, it does not reach the conventional threshold for statistical significance (usually p &lt; 0.05).</p></li>
</ul>
<p>In summary, at a dosage of 5.5, there is strong evidence that treatment A significantly differs from treatment B, with A being more effective or yielding higher response values. The comparisons between A and C, and between B and C, do not show statistically significant differences at the conventional level, although the trend suggests treatment A might be more effective than C, and B less effective than both A and C.</p>
<p>We can visualize this using <code>pwpp</code> function</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pwpp</span>(em_object)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="lmm_files/figure-html/pairwise-p-value-plot-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Example of Pairwise P-value plot</figcaption>
</figure>
</div>
</div>
</div>
<p>Each comparison is associated with a vertical line segment that joins the scale positions of the two EMMs being compared, and whose horizontal position is determined by the P value of that comparison.</p>
<p>The second comparison we are interested in is the effect of dosage between treatments. We can use <code>emtrends</code> for comparing numberical variables (slopes) across different groups:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>em_object_trend <span class="ot">&lt;-</span> <span class="fu">emtrends</span>(model_lmm_treatment_int_rnd, pairwise <span class="sc">~</span> treatment, <span class="at">var =</span> <span class="st">"dosage"</span>,<span class="at">lmer.df =</span> <span class="st">"satterthwaite"</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(em_object_trend)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$emtrends
 treatment dosage.trend    SE   df lower.CL upper.CL
 A                3.050 0.110 2.07     2.59     3.51
 B               -1.977 0.087 2.49    -2.29    -1.66
 C                0.408 0.689 2.15    -2.36     3.18

Degrees-of-freedom method: satterthwaite 
Confidence level used: 0.95 

$contrasts
 contrast estimate    SE   df t.ratio p.value
 A - B        5.03 0.152 2.09  33.004  0.0004
 A - C        2.64 0.769 2.15   3.434  0.1234
 B - C       -2.38 0.714 2.17  -3.340  0.1285

Degrees-of-freedom method: satterthwaite 
P value adjustment: tukey method for comparing a family of 3 estimates </code></pre>
</div>
</div>
<p>The code above calculates and compares the slopes (rate of change) of the response variable with respect to dosage for each treatment group. By specifying <code>pairwise ~ treatment</code>, the code requests pairwise comparisons of these trends between treatments. The <code>var = "dosage"</code> argument indicates that the trend of interest is how the response variable changes with dosage. The output includes two parts: <code>emtrends</code>, which lists the slope (dosage.trend) for each treatment along with its standard error, degrees of freedom, and confidence interval, and <code>contrasts</code>, which presents the pairwise comparisons of these slopes between treatments, including estimates, standard errors, degrees of freedom, t-ratios, and p-values, adjusted using the Tukey method for multiple comparisons.</p>
<p>Dosage Trends per Treatment:</p>
<ul>
<li><p><strong>Treatment A</strong>: Shows a positive trend of 3.050 with dosage, with a standard error (SE) of 0.110 and a 95% confidence interval (CI) from 2.59 to 3.51. This indicates that for treatment A, the response variable increases by approximately 3.050 units with each unit increase in dosage, which is statistically significant and suggests a strong positive dosage effect.</p></li>
<li><p><strong>Treatment B</strong>: Displays a negative dosage trend of -1.977, with an SE of 0.087 and a 95% CI from -2.29 to -1.66. This suggests that for treatment B, the response variable decreases by about 1.977 units for each unit increase in dosage, indicating a significant negative effect of dosage on the response variable.</p></li>
<li><p><strong>Treatment C</strong>: Has a dosage trend of 0.408 with an SE of 0.689 and a 95% CI stretching from -2.36 to 3.18. The wide confidence interval and the proximity of the trend to zero suggest that the dosage effect for treatment C is not statistically significant, implying little to no clear effect of dosage on the response variable for this treatment.</p></li>
</ul>
<p>Pairwise Comparisons of Dosage Trends:</p>
<ul>
<li><p><strong>A vs.&nbsp;B</strong>: The estimated difference in dosage trends between treatments A and B is 5.03, with an SE of 0.152, resulting in a highly significant p-value of 0.0004. This indicates a substantial difference in how dosage affects the response variable between these two treatments, with A increasing and B decreasing in response to higher dosages.</p></li>
<li><p><strong>A vs.&nbsp;C</strong>: Shows an estimate of 2.64 with an SE of 0.769. Despite the positive difference, the p-value of 0.1234 suggests that this difference is not statistically significant at the conventional 0.05 level, though it indicates a trend towards a stronger positive effect of dosage for treatment A compared to C.</p></li>
<li><p><strong>B vs.&nbsp;C</strong>: The difference in dosage trends between treatments B and C is -2.38, with an SE of 0.714. The p-value of 0.1285, while not conventionally significant, suggests a moderate difference in the effect of dosage between these treatments, with B showing a negative trend and C showing an insignificant positive trend.</p></li>
</ul>
<p>We can also use <code>pwpp</code> and <code>plot</code> function to visualize the results.</p>
<p>There is a lot more that can be done using <code>emmeans</code> package for example if we have two interacting factors instead of one. You should really check out the emmeans package homepage to learn more about how different analysis can be performed.</p>
<section id="anova-type-i-ii-and-iii" class="level3">
<h3 class="anchored" data-anchor-id="anova-type-i-ii-and-iii">ANOVA type I, II, and III</h3>
<p>Sometimes we are only interested in if a variable in the model is significant or not. This is normally simple when it comes to numerical variables but it can get a bit complicated with categorical variables, especially if they have multiple levels. ANOVA provides a type of analysis that allows us to compare the means of the different levels of a categorical variable simultaneously to determine if there is a statistically significant difference among them. This is particularly useful because it accounts for the variability within each group and between groups, enabling a comprehensive assessment of how the categorical variable, as a whole, influences the response variable.</p>
<p>There different types of ANOVA analysis but we are going to explain type 1 to 3 here.</p>
<p><strong>Type I ANOVA</strong>, also known as sequential sum of squares (SS), tests each predictor’s effect on the outcome variable in the order specified in the model. It’s sensitive to the order of variables in the model because it evaluates the additional contribution of each variable after accounting for the variables entered before it. Type I ANOVA is most suitable for models where predictors have a natural hierarchical order, or for simple designs without interactions or with only one main effect. It’s often used in purely observational studies where the order of variables can reflect the temporal or causal sequence of their introduction into the system. This is however, rarely used in practice in many applications so we are going to leave it here and proceed to Type II ANOVA.</p>
<p><strong>Type II ANOVA</strong> examines the main effects of each factor after accounting for other main effects in the model but does not consider interactions involving the factor being assessed. It’s less sensitive to the order of variables than Type I ANOVA. It is useful in factorial designs where interaction effects are <strong>NOT</strong> the main focus or when you want to assess the unique contribution of each main effect after accounting for other main effects.</p>
<p>Finally, <strong>Type III ANOVA</strong>, or marginal sum of squares, evaluates the effect of each predictor while accounting for all other predictors in the model, including interactions. This type does not depend on the order of variables and is considered the most general approach.</p>
<p>We can use <code>joint_tests</code> from <code>emmeans</code> package to perform type II and type III ANOVA:</p>
<p>Type II:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">joint_tests</span>(model_lmm_treatment_int_rnd,<span class="at">lmer.df =</span> <span class="st">"satterthwaite"</span>) <span class="do">## type 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> model term       df1  df2   F.ratio p.value
 treatment          2 2.15 51058.190  &lt;.0001
 dosage             1 2.14     6.160  0.1229
 treatment:dosage   2 2.09   625.980  0.0012</code></pre>
</div>
</div>
<p>Type III:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">joint_tests</span>(model_lmm_treatment_int_rnd,<span class="at">lmer.df =</span> <span class="st">"satterthwaite"</span>) <span class="do">## type 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> model term       df1  df2   F.ratio p.value
 treatment          2 2.15 51058.190  &lt;.0001
 dosage             1 2.14     6.160  0.1229
 treatment:dosage   2 2.09   625.980  0.0012</code></pre>
</div>
</div>
<p>The interpretation is the key here. in the type II model the assumption is that the interaction is tested first and is not significant; if interaction is significant, Type II is generally not recommended. ANOVA type II is more powerful than Type III when interactions are not significant due to its focus on main effects in isolation from interaction effects.</p>
<p>Please recall that Type III tests for each main effect after accounting for all other factors and interactions, making it robust in the presence of significant interactions. However, while Type III allows for the testing of main effects even when interactions are present, interpreting these main effects can be complex and potentially misleading due to the significance of interactions.</p>
<p>Generally speaking, if the interactions are not significant, type II gives a more powerful test but if an interaction is significant Type III can be used but it is not really interesting to interpret a main effect to start with.</p>
</section>
</section>
<section id="power-calculation" class="level2">
<h2 class="anchored" data-anchor-id="power-calculation">Power calculation</h2>
<p>Statistical power is defined as the probability of correctly rejecting the null hypothesis when it is false, or in other words, the likelihood that a study will detect an effect when there is an effect to be detected.</p>
<p>One way to calculate power is through data simulation. This process involves generating a large number of datasets that resemble the expected structure and variation of your real-world data, under both the null hypothesis (where the effect you’re testing for is absent) and the alternative hypothesis (where the effect is present). In the case of power analysis, we simulate data assuming the effect we’re testing for does exist at a specific magnitude. This allows us to see how often we can expect to correctly detect the effect, given the true difference and our study design. The key to these simulations is the introduction of randomness in a controlled manner. By introducing randomness in this way, each simulated dataset gives us one possible outcome of our study if it were conducted under the exact same conditions. Running thousands of these simulations provides a robust overview of the range of possible outcomes we might expect. We can use <code>simulate</code> function to generate simulated data:</p>
<p>For speeding up the process we are going to use only 10 simulations. In reality this number must be much higher.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>simple_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>boundary (singular) fit: see help('isSingular')</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>simulated_data<span class="ot">&lt;-</span><span class="fu">simulate</span>(<span class="at">object =</span> simple_model,<span class="at">nsim =</span> <span class="dv">10</span>,<span class="at">seed =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Each of the simulated recovery times is now in a column of <code>simulated_data</code>. We can fit a model for each of these new responses followed by statistical analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>tmp_data<span class="ot">&lt;-</span>data_int_interaction</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>stat_information<span class="ot">&lt;-</span><span class="fu">lapply</span>(simulated_data,<span class="cf">function</span>(x){</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a> simple_model_refit <span class="ot">&lt;-</span> <span class="fu">refit</span>(simple_model,x)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  em_obj <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(simple_model_refit,<span class="at">specs =</span> <span class="st">"treatment"</span>,<span class="at">by =</span> <span class="st">"dosage"</span>,<span class="at">lmer.df =</span> <span class="st">"satterthwaite"</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="fu">pairs</span>(em_obj,<span class="at">adjust=</span><span class="st">"none"</span>))</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>cp_A_B<span class="ot">&lt;-</span><span class="fu">sapply</span>(stat_information,<span class="cf">function</span>(x){x[<span class="dv">1</span>,<span class="st">"p.value"</span>]})</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>cp_A_C<span class="ot">&lt;-</span><span class="fu">sapply</span>(stat_information,<span class="cf">function</span>(x){x[<span class="dv">2</span>,<span class="st">"p.value"</span>]})</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>cp_B_C<span class="ot">&lt;-</span><span class="fu">sapply</span>(stat_information,<span class="cf">function</span>(x){x[<span class="dv">3</span>,<span class="st">"p.value"</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After extracting the p-values for each comparisons and for each simulation. We can define power as proportion of the p-values lower than our alpha level. We can even calculate confidence intervals etc:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"A - B power: "</span>,<span class="fu">mean</span>(cp_A_B<span class="sc">&lt;</span><span class="fl">0.05</span>)<span class="sc">*</span><span class="dv">100</span>,<span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>A - B power:  100 %</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"A - B conf.level: "</span>,<span class="fu">binom.test</span>(<span class="at">x =</span> <span class="fu">sum</span>(cp_A_B<span class="sc">&lt;</span><span class="fl">0.05</span>), <span class="at">n =</span> <span class="fu">length</span>(cp_A_B), </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">conf.level =</span> .<span class="dv">95</span>)<span class="sc">$</span>conf.int<span class="sc">*</span><span class="dv">100</span>,<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>A - B conf.level:  69.15029 100 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"A - C power: "</span>,<span class="fu">mean</span>(cp_A_C<span class="sc">&lt;</span><span class="fl">0.05</span>)<span class="sc">*</span><span class="dv">100</span>,<span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>A - C power:  40 %</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"A - C conf.level: "</span>,<span class="fu">binom.test</span>(<span class="at">x =</span> <span class="fu">sum</span>(cp_A_C<span class="sc">&lt;</span><span class="fl">0.05</span>), <span class="at">n =</span> <span class="fu">length</span>(cp_A_C), </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">conf.level =</span> .<span class="dv">95</span>)<span class="sc">$</span>conf.int<span class="sc">*</span><span class="dv">100</span>,<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>A - C conf.level:  12.15523 73.76219 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"B - C power: "</span>,<span class="fu">mean</span>(cp_B_C<span class="sc">&lt;</span><span class="fl">0.05</span>)<span class="sc">*</span><span class="dv">100</span>,<span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>B - C power:  80 %</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"B - C conf.level: "</span>,<span class="fu">binom.test</span>(<span class="at">x =</span> <span class="fu">sum</span>(cp_B_C<span class="sc">&lt;</span><span class="fl">0.05</span>), <span class="at">n =</span> <span class="fu">length</span>(cp_B_C), </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">conf.level =</span> .<span class="dv">95</span>)<span class="sc">$</span>conf.int<span class="sc">*</span><span class="dv">100</span>,<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>B - C conf.level:  44.39045 97.47893 </code></pre>
</div>
</div>
<p>There are also some packages such as <code>simr</code> that can be used to perform power analysis based on simulation.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./lm.html" class="pagination-link" aria-label="Simple linear regression">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Simple linear regression</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./environment.html" class="pagination-link" aria-label="Environment">
        <span class="nav-page-text">Environment</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>